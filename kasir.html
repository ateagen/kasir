<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kasir - Bunda Ana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Total Penjualan Hari Ini -->
  <header class="p-4 bg-blue-600 text-white text-center text-xl font-bold">
    Total Penjualan Hari Ini: Rp <span id="total-hari-ini">0</span>
  </header>

  <main class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-4 p-4">
    <!-- Grid Menu -->
    <section class="md:col-span-2">
      <h2 class="text-lg font-semibold mb-2">Menu</h2>
      <div id="menu-grid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4"></div>
    </section>

    <!-- Daftar Pesanan -->
    <section class="bg-white rounded-xl shadow p-4 flex flex-col">
      <h2 class="text-lg font-semibold mb-2">Pesanan</h2>
      <ul id="daftar-pesanan" class="flex-1 overflow-y-auto mb-2"></ul>
      <div class="mb-2">Total: Rp <span id="total-belanja">0</span></div>
      <input id="input-bayar" type="number" placeholder="Bayar"
             class="w-full border p-2 rounded mb-2">
      <div class="mb-2">Kembalian: Rp <span id="kembalian">0</span></div>
      <button id="btn-bayar" class="w-full bg-green-500 text-white py-2 rounded mb-2">Bayar</button>
      <button id="btn-batal" class="w-full bg-red-500 text-white py-2 rounded mb-2">Batal</button>
      <a href="index.html" class="w-full block bg-gray-500 text-white py-2 rounded text-center">Kembali</a>
    </section>
  </main>

  <script>
    // Supabase config
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let pesanan = [];

    // Load total penjualan hari ini
    async function loadTotalHariIni() {
      const today = new Date().toISOString().split("T")[0];
      const { data, error } = await supabase
        .from("transaksi")
        .select("total")
        .gte("tanggal", today + "T00:00:00")
        .lte("tanggal", today + "T23:59:59");

      if (error) {
        console.error("Error total hari ini:", error);
        return;
      }

      const total = data.reduce((sum, t) => sum + t.total, 0);
      document.getElementById("total-hari-ini").textContent = total.toLocaleString();
    }

    // Load menu
    async function loadMenu() {
      const { data, error } = await supabase
        .from("menu")
        .select("id, nama, harga");

      console.log("=== DEBUG MENU ===");
      console.log("Data:", data);
      console.log("Error:", error);

      const menuGrid = document.getElementById("menu-grid");
      menuGrid.innerHTML = "";

      if (error) {
        menuGrid.innerHTML = `<p class="col-span-full text-center text-red-500">Gagal ambil menu: ${error.message}</p>`;
        return;
      }

      if (!data || data.length === 0) {
        menuGrid.innerHTML = `<p class="col-span-full text-center text-gray-500">Belum ada menu</p>`;
        return;
      }

      data.forEach(item => {
        const card = document.createElement("div");
        card.className = "p-4 bg-white rounded-xl shadow cursor-pointer hover:bg-gray-100";
        card.innerHTML = `
          <h3 class="font-semibold">${item.nama}</h3>
          <p>Rp ${item.harga.toLocaleString()}</p>
        `;
        card.onclick = () => tambahPesanan(item);
        menuGrid.appendChild(card);
      });
    }

    function tambahPesanan(item) {
      const existing = pesanan.find(p => p.id === item.id);
      if (existing) {
        existing.qty++;
      } else {
        pesanan.push({ ...item, qty: 1 });
      }
      renderPesanan();
    }

    function renderPesanan() {
      const list = document.getElementById("daftar-pesanan");
      list.innerHTML = "";
      let total = 0;
      pesanan.forEach(p => {
        const li = document.createElement("li");
        const subtotal = p.qty * p.harga;
        total += subtotal;
        li.textContent = `${p.nama} x${p.qty} = Rp ${subtotal.toLocaleString()}`;
        list.appendChild(li);
      });
      document.getElementById("total-belanja").textContent = total.toLocaleString();
      hitungKembalian();
    }

    function hitungKembalian() {
      const bayar = parseInt(document.getElementById("input-bayar").value) || 0;
      const total = pesanan.reduce((sum, p) => sum + p.qty * p.harga, 0);
      const kembali = bayar - total;
      document.getElementById("kembalian").textContent = kembali >= 0 ? kembali.toLocaleString() : 0;
    }

    document.getElementById("input-bayar").addEventListener("input", hitungKembalian);

    // Tombol batal
    document.getElementById("btn-batal").onclick = () => {
      pesanan = [];
      renderPesanan();
      document.getElementById("input-bayar").value = "";
      document.getElementById("kembalian").textContent = "0";
    };

    // Tombol bayar
    document.getElementById("btn-bayar").onclick = async () => {
      if (pesanan.length === 0) return alert("Belum ada pesanan");

      const total = pesanan.reduce((sum, p) => sum + p.qty * p.harga, 0);
      const bayar = parseInt(document.getElementById("input-bayar").value) || 0;
      if (bayar < total) return alert("Uang bayar kurang");

      const kembali = bayar - total;
      const kasir = localStorage.getItem("kasir") || "Kasir";
      const tanggal = new Date().toISOString();

      // Simpan transaksi
      const { data: trx, error } = await supabase
        .from("transaksi")
        .insert([{ tanggal, total, bayar, kembali, kasir }])
        .select()
        .single();

      console.log("=== DEBUG TRANSAKSI ===");
      console.log("Transaksi:", trx, "Error:", error);

      if (error) return alert("Gagal simpan transaksi: " + error.message);

      for (let p of pesanan) {
        await supabase.from("detail_transaksi").insert([{
          transaksi_id: trx.id,
          menu_id: p.id,
          qty: p.qty,
          harga: p.harga
        }]);
      }

      cetakStruk({ kasir, tanggal, pesanan, total, bayar, kembali });
      document.getElementById("btn-batal").click();
      loadTotalHariIni();
    };

    // Cetak struk
    function cetakStruk({ kasir, tanggal, pesanan, total, bayar, kembali }) {
      const w = window.open("", "Print", "width=300,height=600");
      w.document.write(`
        <pre>
Bunda Ana
${new Date(tanggal).toLocaleString()}
Kasir: ${kasir}

${pesanan.map(p => `${p.nama} x${p.qty} = Rp ${(p.qty * p.harga).toLocaleString()}`).join("\n")}

Total: Rp ${total.toLocaleString()}
Bayar: Rp ${bayar.toLocaleString()}
Kembali: Rp ${kembali.toLocaleString()}

Terima kasih
        </pre>
      `);
      w.document.close();
      w.print();
    }

    // Init
    loadMenu();
    loadTotalHariIni();
  </script>
</body>
</html>
