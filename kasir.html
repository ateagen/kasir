<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>POS Kasir - Resto Bunda Ana</title>
<style>
  * { box-sizing: border-box; }
  body { margin:0; font-family: Arial, sans-serif; background-color: #e0f0ff; color: #333; }
  header { background-color: #b3e0ff; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; color: #064273; display:flex; justify-content:space-between; align-items:center; box-shadow:0 2px 5px rgba(0,0,0,0.1); }
  header button{padding:0.3rem 0.6rem;border:none;border-radius:5px;cursor:pointer;}
  .container { display:flex; height: calc(100vh - 60px); flex-wrap: wrap; }
  .sidebar { width: 200px; background-color: #a0d8ff; padding:1rem; display:flex; flex-direction:column; gap:0.5rem; }
  .sidebar button { padding:0.7rem; border:none; border-radius:8px; background-color:#7ecfff; cursor:pointer; font-weight:bold; transition:0.2s; }
  .sidebar button:hover { background-color:#64c8ff; }
  .main { flex:1; padding:1rem; display:flex; flex-wrap:wrap; gap:1rem; overflow-y:auto; justify-content:flex-start; align-content:flex-start; }
  .menu-card { width:120px; height:120px; background-color:#d0f0ff; border-radius:12px; display:flex; justify-content:center; align-items:center; cursor:pointer; text-align:center; font-weight:bold; transition:0.2s; box-shadow:0 3px 6px rgba(0,0,0,0.1); }
  .menu-card:hover { background-color:#a0d8ff; transform:translateY(-3px); }
  .sidebar-right { width:300px; background-color:#cceeff; padding:1rem; display:flex; flex-direction:column; gap:0.5rem; overflow-y:auto; }
  .order-item { display:flex; justify-content:space-between; margin-bottom:0.5rem; }
  .total { font-weight:bold; margin-top:1rem; }
  .btn-pay, .btn-reset { margin-top:0.5rem; padding:0.5rem; border:none; border-radius:8px; cursor:pointer; font-weight:bold; }
  .btn-pay { background-color:#4CAF50; color:white; }
  .btn-pay:hover { background-color:#45a049; }
  .btn-reset { background-color:#f44336; color:white; }
  .btn-reset:hover { background-color:#da190b; }
  /* Pop-up loading */
  .loading-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(0,0,0,0.3); display: flex; justify-content: center; align-items: center; display:none; z-index:999; }
  .spinner { border:8px solid #f3f3f3; border-top:8px solid #3498db; border-radius:50%; width:60px; height:60px; animation:spin 1s linear infinite; }
  @keyframes spin {0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
  /* Pop-up modal */
  .modal { display:none; position: fixed; z-index:1000; left:0; top:0; width:100%; height:100%; overflow:auto; background-color: rgba(0,0,0,0.4); }
  .modal-content { background-color:#fefefe; margin:15% auto; padding:1rem; border:1px solid #888; width:300px; border-radius:10px; text-align:center; }
  .modal-content button { margin:0.5rem; padding:0.5rem 1rem; }
  /* Input form pengeluaran */
  .expense-form { display:flex; flex-direction:column; gap:0.5rem; background-color:#d0f0ff; padding:0.5rem; border-radius:8px; }
  .expense-form input { padding:0.5rem; border-radius:6px; border:1px solid #888; }
  @media(max-width:900px) { .container{flex-direction:column} .sidebar,.sidebar-right{width:100%; display:flex; flex-direction:row; overflow-x:auto;} .sidebar button{flex:1;margin-right:0.5rem;} }
</style>
</head>
<body>
<header>
  <button onclick="window.location.href='index.html'">Kembali</button>
  POS Kasir - Resto Bunda Ana
</header>

<div class="container">
  <div class="sidebar">
    <button onclick="loadMenu('Semua')">Semua Menu</button>
    <button onclick="loadMenu('Makanan')">Makanan</button>
    <button onclick="loadMenu('Minuman')">Minuman</button>
    <button onclick="loadMenu('Cemilan')">Cemilan</button>
    <button onclick="showExpenseForm()">Input Pengeluaran</button>
  </div>
  <div class="main" id="main-content"></div>
  <div class="sidebar-right">
    <h3>Daftar Pesanan</h3>
    <div id="order-list"></div>
    <div class="total" id="total-amount">Total: Rp 0</div>
    <input type="number" id="input-bayar" placeholder="Bayar" />
    <div class="total" id="kembalian">Kembalian: Rp 0</div>
    <button class="btn-reset" onclick="resetOrder()">Reset Pesanan</button>
    <button class="btn-pay" onclick="payOrder()">Bayar</button>
  </div>
</div>

<div id="modal-print" class="modal">
  <div class="modal-content">
    <p>Cetak struk?</p>
    <button onclick="confirmPrint(true)">Ya</button>
    <button onclick="confirmPrint(false)">Tidak</button>
  </div>
</div>

<div id="loading" class="loading-overlay"><div class="spinner"></div></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabaseUrl = 'https://ekggvrzuguczvdvvzmri.supabase.co'
const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVrZ2d2cnZ6bXJpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTczOTEyOTksImV4cCI6MjA3Mjk2NzI5OX0.S0pdzwQbC1poh3BbwtupFxSDxQ_6FBdbhGsU2DNexfQ'
const supabase = createClient(supabaseUrl, supabaseAnonKey)

let menuData=[], orders=[]

// ================= Loading =================
const showLoading=(show)=>{ document.getElementById('loading').style.display = show ? 'flex':'none'; }

// ================= Load Menu =================
window.loadMenu = async(kategori)=>{
  showLoading(true)
  let { data, error } = await supabase.from('menu').select('*')
  if(error){ alert(error.message); showLoading(false); return; }
  if(kategori!=='Semua') data = data.filter(m=>m.kategori===kategori)
  menuData=data
  renderMenu()
  showLoading(false)
}

// ================= Render Menu =================
const renderMenu=()=>{
  const main = document.getElementById('main-content')
  main.innerHTML=''
  menuData.forEach(item=>{
    const div=document.createElement('div')
    div.className='menu-card'
    div.innerText=`${item.nama}\nRp ${item.harga}`
    div.onclick=()=>addOrder(item)
    main.appendChild(div)
  })
}

// ================= Orders =================
const addOrder=(item)=>{
  const exist = orders.find(o=>o.id===item.id)
  if(exist){ exist.qty+=1 } else { orders.push({id:item.id,name:item.nama,price:item.harga,qty:1}) }
  renderOrders()
}

const renderOrders = () => {
  const list = document.getElementById('order-list')
  list.innerHTML = ''
  let total = 0
  orders.forEach(o => {
    total += o.price * o.qty
    const div = document.createElement('div')
    div.className = 'order-item'
    div.innerText = `${o.name} x${o.qty} = Rp ${o.price*o.qty}`
    list.appendChild(div)
  })
  document.getElementById('total-amount').innerText = 'Total: Rp ' + total
}

// ================= Kalkulasi Kembalian =================
window.calcKembalian = ()=>{
  const bayar = parseInt(document.getElementById('input-bayar').value) || 0
  let total = orders.reduce((a,o)=>a+o.price*o.qty,0)
  document.getElementById('kembalian').innerText = 'Kembalian: Rp ' + Math.max(0, bayar - total)
}
document.getElementById('input-bayar').addEventListener('input', window.calcKembalian)

// ================= Reset Order =================
window.resetOrder = ()=>{
  if(confirm('Reset semua pesanan?')){
    orders=[]
    renderOrders()
    document.getElementById('input-bayar').value=''
    document.getElementById('kembalian').innerText='Kembalian: Rp 0'
  }
}

// ================= Bayar =================
window.payOrder = async ()=>{
  if(orders.length===0){ alert('Pesanan kosong'); return; }
  const bayar = parseInt(document.getElementById('input-bayar').value) || 0
  let total = orders.reduce((a,o)=>a+o.price*o.qty,0)
  if(bayar < total){ alert('Pembayaran kurang'); return; }
  showLoading(true)

  // Insert transaksi
  const { data:trx, error:e1 } = await supabase.from('transaksi').insert([{total_penjualan: total, total_pengeluaran:0}]).select().single()
  if(e1){ alert('Error transaksi: '+e1.message); showLoading(false); return; }

  // Insert transaksi_detail
  const details = orders.map(o=>({id_transaksi: trx.id, tipe:'Menu', nama_item:o.name, jumlah:o.qty, harga:o.price, debit:o.price*o.qty, kredit:0}))
  const { error:e2 } = await supabase.from('transaksi_detail').insert(details)
  showLoading(false)
  if(e2){ alert('Error detail: '+e2.message); return; }

  document.getElementById('modal-print').style.display='block'
}

// ================= Konfirmasi Cetak =================
window.confirmPrint=(yes)=>{
  document.getElementById('modal-print').style.display='none'
  if(yes){
    let struk = `Resto Bunda Ana\nTanggal: ${new Date().toLocaleString()}\n\nPesanan:\n`
    orders.forEach(o=>{ struk += `${o.name} x${o.qty} = Rp ${o.price*o.qty}\n` })
    struk += `\nTotal: Rp ${orders.reduce((a,o)=>a+o.price*o.qty,0)}\n`
    console.log("CETAK STRUK\n"+struk)
    alert("Struk dicetak (cek console)")
  }
  resetOrder()
}

// ================= Input Pengeluaran =================
window.showExpenseForm = ()=>{
  const main = document.getElementById('main-content')
  main.innerHTML = `
    <div class="expense-form">
      <h3>Input Pengeluaran</h3>
      <input type="text" id="exp-ket" placeholder="Keterangan">
      <input type="number" id="exp-jumlah" placeholder="Jumlah">
      <input type="number" id="exp-harga" placeholder="Harga">
      <button onclick="submitExpense()">Submit</button>
    </div>
  `
}

window.submitExpense = async ()=>{
  const ket=document.getElementById('exp-ket').value
  const jumlah=parseInt(document.getElementById('exp-jumlah').value)||0
  const harga=parseInt(document.getElementById('exp-harga').value)||0
  if(!ket || jumlah<=0 || harga<=0){ alert('Isi data dengan benar'); return; }
  showLoading(true)
  const { data, error } = await supabase.from('transaksi_detail').insert([{tipe:'Pengeluaran', nama_item:ket, jumlah, harga, debit:0, kredit:jumlah*harga}])
  showLoading(false)
  if(error){ alert(error.message); return; }
  alert('Pengeluaran tersimpan')
  document.getElementById('main-content').innerHTML=''
}

window.loadMenu('Semua') // default
</script>
</body>
</html>
