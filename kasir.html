<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kasir</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @media print {
      body * { visibility: hidden; font-family: monospace; }
      #printArea, #printArea * { visibility: visible; }
      #printArea {
        position: absolute;
        left: 0;
        top: 0;
        width: 58mm;
        font-size: 11px;
        line-height: 1.2;
        padding: 4px;
      }
      #printArea h2 { font-size: 14px; margin: 2px 0; text-align: center; }
      #printArea table { width: 100%; font-size: 11px; }
      #printArea td, #printArea th { padding: 2px 0; text-align: left; }
      #printArea hr { border: none; border-top: 1px dashed #000; margin: 4px 0; }
      #printArea p { margin: 2px 0; }
    }
  </style>
</head>
<body class="bg-gray-100 p-6">

  <!-- Login -->
  <div id="loginSection" class="max-w-sm mx-auto bg-white p-6 rounded-xl shadow">
    <h2 class="text-xl font-bold mb-4 text-center">Login Kasir</h2>
    <input id="loginUser" placeholder="Username" class="w-full border p-2 mb-3 rounded">
    <input id="loginPass" type="password" placeholder="Password" class="w-full border p-2 mb-3 rounded">
    <button onclick="loginKasir()" class="w-full bg-blue-600 text-white p-2 rounded">Login</button>
    <p id="loginError" class="text-red-500 mt-2 text-center hidden">Login gagal!</p>
  </div>

  <!-- Kasir Panel -->
  <div id="kasirSection" class="hidden">
    <h2 class="text-xl font-bold mb-4">Halo, <span id="kasirName"></span></h2>

    <!-- Pilih menu -->
    <div class="flex gap-2 mb-4">
      <select id="menuSelect" class="border p-2 rounded w-2/3"></select>
      <input id="qtyInput" type="number" min="1" value="1" class="border p-2 rounded w-1/3" />
      <button onclick="tambahItem()" class="bg-green-600 text-white px-4 rounded">Tambah</button>
    </div>

    <!-- Keranjang -->
    <table class="w-full bg-white rounded shadow mb-4">
      <thead class="bg-gray-200">
        <tr><th class="p-2">Item</th><th>Qty</th><th>Total</th></tr>
      </thead>
      <tbody id="cartTable"></tbody>
    </table>

    <!-- Bayar -->
    <div class="bg-white p-4 rounded shadow mb-4">
      <p>Total: Rp <span id="totalHarga">0</span></p>
      <input id="bayarInput" type="number" placeholder="Uang bayar" class="border p-2 rounded w-full mt-2" oninput="hitungKembali()" />
      <p class="mt-2">Kembali: Rp <span id="kembaliHarga">0</span></p>
    </div>

    <!-- Tombol -->
    <div class="flex gap-2">
      <button onclick="simpanTransaksi()" class="flex-1 bg-blue-600 text-white p-2 rounded">Bayar</button>
      <button onclick="cetakStruk()" class="flex-1 bg-gray-800 text-white p-2 rounded">Cetak Struk</button>
    </div>
  </div>

  <!-- Area Print -->
  <div id="printArea" class="hidden">
    <h2>TOKO KITA</h2>
    <p>No: <span id="strukNo"></span></p>
    <p>Kasir: <span id="strukKasir"></span></p>
    <p>Waktu: <span id="strukWaktu"></span></p>
    <hr>
    <table>
      <thead><tr><th>Item</th><th>Qty</th><th>Total</th></tr></thead>
      <tbody id="strukItems"></tbody>
    </table>
    <hr>
    <p>Total: Rp <span id="strukTotal"></span></p>
    <p>Bayar: Rp <span id="strukBayar"></span></p>
    <p>Kembali: Rp <span id="strukKembali"></span></p>
    <hr>
    <p class="text-center">~ Terima Kasih ~</p>
  </div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbyNWXKPM9tuGjwS7YLvNEoxV0CYoVYeEPEqvWqmBcAVi_SqnEFvXPXpLvppJOg68Ps/exec"; // ganti dengan URL WebApp Google Apps Script
let menuList = [], cart = [], currentKasir = "";
let uangBayar = 0, kembalian = 0;

// Login Kasir
async function loginKasir() {
  const user = document.getElementById("loginUser").value.trim();
  const pass = document.getElementById("loginPass").value.trim();
  const res = await fetch(`${scriptURL}?action=getKasir`);
  const data = await res.json();
  const kasir = data.find(k => k.Username === user && k.Password === pass);
  if (kasir) {
    currentKasir = kasir.Username;
    document.getElementById("kasirName").innerText = currentKasir;
    document.getElementById("loginSection").classList.add("hidden");
    document.getElementById("kasirSection").classList.remove("hidden");
    loadMenu();
  } else {
    document.getElementById("loginError").classList.remove("hidden");
  }
}

// Load menu dari Sheet
async function loadMenu() {
  const res = await fetch(`${scriptURL}?action=getMenu`);
  menuList = await res.json();
  const select = document.getElementById("menuSelect");
  select.innerHTML = "";
  menuList.forEach(m => {
    const opt = document.createElement("option");
    opt.value = m.Nama;
    opt.textContent = `${m.Nama} - Rp${m.Harga}`;
    select.appendChild(opt);
  });
}

// Tambah item ke keranjang
function tambahItem() {
  const nama = document.getElementById("menuSelect").value;
  const qty = parseInt(document.getElementById("qtyInput").value);
  const menu = menuList.find(m => m.Nama === nama);
  const total = qty * parseInt(menu.Harga);
  cart.push({Nama: nama, Qty: qty, Total: total});
  renderCart();
}

// Render keranjang
function renderCart() {
  const tbody = document.getElementById("cartTable");
  tbody.innerHTML = "";
  let total = 0;
  cart.forEach(c => {
    const tr = document.createElement("tr");
    tr.innerHTML = `<td class="p-2">${c.Nama}</td><td>${c.Qty}</td><td>Rp${c.Total}</td>`;
    tbody.appendChild(tr);
    total += c.Total;
  });
  document.getElementById("totalHarga").innerText = total;
}

// Hitung kembali
function hitungKembali() {
  uangBayar = parseInt(document.getElementById("bayarInput").value) || 0;
  const total = cart.reduce((s,c)=>s+c.Total,0);
  kembalian = uangBayar - total;
  document.getElementById("kembaliHarga").innerText = kembalian;
}

// Simpan transaksi ke Sheet
async function simpanTransaksi() {
  if (cart.length === 0) return alert("Keranjang kosong!");
  const total = cart.reduce((s,c)=>s+c.Total,0);
  const noTrx = "TRX-" + Date.now();
  const data = {
    action: "addTransaksi",
    NoTransaksi: noTrx,
    Kasir: currentKasir,
    Waktu: new Date().toLocaleString(),
    Items: JSON.stringify(cart),
    Total: total,
    Bayar: uangBayar,
    Kembali: kembalian
  };
  await fetch(scriptURL, {
    method: "POST",
    body: JSON.stringify(data)
  });
  alert("Transaksi tersimpan!");
  document.getElementById("strukNo").innerText = noTrx;
  document.getElementById("strukKasir").innerText = currentKasir;
  document.getElementById("strukWaktu").innerText = new Date().toLocaleString();
  document.getElementById("strukTotal").innerText = total;
  document.getElementById("strukBayar").innerText = uangBayar;
  document.getElementById("strukKembali").innerText = kembalian;
  const list = document.getElementById("strukItems");
  list.innerHTML = "";
  cart.forEach(c=>{
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${c.Nama}</td><td>${c.Qty}</td><td>Rp${c.Total}</td>`;
    list.appendChild(tr);
  });
  cart = [];
  renderCart();
  document.getElementById("bayarInput").value="";
  document.getElementById("kembaliHarga").innerText=0;
}

// Cetak struk
function cetakStruk() {
  window.print();
}
</script>
</body>
</html>
