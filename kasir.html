<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kasir - Bunda Ana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Total penjualan hari ini -->
  <div class="bg-green-600 text-white p-4 text-center text-xl font-bold">
    Total Penjualan Hari Ini: Rp <span id="totalHariIni">0</span>
  </div>

  <!-- Grid Menu -->
  <div class="flex-1 p-4">
    <h2 class="text-lg font-bold mb-2">Pilih Menu</h2>
    <div id="menuGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
  </div>

  <!-- Daftar Pesanan -->
  <div class="bg-white shadow-lg p-4">
    <h2 class="text-lg font-bold mb-2">Daftar Pesanan</h2>
    <ul id="daftarPesanan" class="mb-2"></ul>
    <div class="font-bold">Total: Rp <span id="totalBelanja">0</span></div>

    <div class="mt-2">
      <label class="block">Bayar:</label>
      <input id="bayarInput" type="number" class="border p-2 w-full" placeholder="Masukkan jumlah bayar">
    </div>
    <div class="mt-2 font-bold">Kembali: Rp <span id="kembaliBelanja">0</span></div>

    <div class="flex gap-2 mt-4">
      <button id="batalBtn" class="bg-red-500 text-white px-4 py-2 rounded">Batal</button>
      <button id="bayarBtn" class="bg-blue-500 text-white px-4 py-2 rounded">Bayar</button>
      <a href="index.html" class="bg-gray-500 text-white px-4 py-2 rounded">Kembali</a>
    </div>
  </div>

  <script>
    // Supabase init
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let pesanan = [];
    let total = 0;

    const menuGrid = document.getElementById("menuGrid");
    const daftarPesanan = document.getElementById("daftarPesanan");
    const totalBelanja = document.getElementById("totalBelanja");
    const bayarInput = document.getElementById("bayarInput");
    const kembaliBelanja = document.getElementById("kembaliBelanja");
    const totalHariIni = document.getElementById("totalHariIni");

    const kasirNama = localStorage.getItem("kasir") || "Kasir";

    // Load menu
    async function loadMenu() {
      let { data, error } = await supabase.from("menu").select("*");
      console.log("=== DEBUG MENU ===", data, error);
      if (error) return alert("Gagal ambil menu");

      menuGrid.innerHTML = "";
      data.forEach(item => {
        const div = document.createElement("div");
        div.className = "bg-white shadow p-4 rounded cursor-pointer hover:bg-green-100";
        div.innerHTML = `<div class="font-bold">${item.nama}</div><div>Rp ${item.harga}</div>`;
        div.onclick = () => tambahPesanan(item);
        menuGrid.appendChild(div);
      });
    }

    // Tambah pesanan
    function tambahPesanan(item) {
      const existing = pesanan.find(p => p.id === item.id);
      if (existing) {
        existing.jumlah++;
        existing.subtotal = existing.jumlah * item.harga;
      } else {
        pesanan.push({
          id: item.id,
          nama: item.nama,
          harga: item.harga,
          jumlah: 1,
          subtotal: item.harga
        });
      }
      renderPesanan();
    }

    // Render pesanan
    function renderPesanan() {
      daftarPesanan.innerHTML = "";
      total = 0;
      pesanan.forEach(p => {
        total += p.subtotal;
        const li = document.createElement("li");
        li.textContent = `${p.nama} x${p.jumlah} = Rp ${p.subtotal}`;
        daftarPesanan.appendChild(li);
      });
      totalBelanja.textContent = total;
      hitungKembali();
    }

    // Hitung kembalian
    function hitungKembali() {
      const bayar = parseInt(bayarInput.value) || 0;
      const kembali = bayar - total;
      kembaliBelanja.textContent = kembali >= 0 ? kembali : 0;
    }
    bayarInput.addEventListener("input", hitungKembali);

    // Batal pesanan
    document.getElementById("batalBtn").onclick = () => {
      pesanan = [];
      renderPesanan();
      bayarInput.value = "";
      kembaliBelanja.textContent = 0;
    };

    // Simpan transaksi + cetak
    document.getElementById("bayarBtn").onclick = async () => {
      const bayar = parseInt(bayarInput.value) || 0;
      const kembali = bayar - total;
      if (total === 0) return alert("Belum ada pesanan");
      if (bayar < total) return alert("Uang bayar kurang");

      const transaksi = {
        tanggal: new Date().toISOString(),
        total,
        bayar,
        kembali,
        kasir: kasirNama
      };

      let { data, error } = await supabase.from("transaksi").insert([transaksi]);
      console.log("=== DEBUG TRANSAKSI ===", data, error);

      if (error) {
        alert("Gagal simpan transaksi");
        return;
      }

      cetakStruk(transaksi);
      pesanan = [];
      renderPesanan();
      bayarInput.value = "";
      loadTotalHariIni();
    };

    // Cetak struk
    function cetakStruk(trx) {
      const win = window.open("", "Print", "width=300,height=600");
      win.document.write(`<pre>
       Bunda Ana
Tanggal : ${new Date(trx.tanggal).toLocaleString()}
Kasir   : ${trx.kasir}

Pesanan :
${pesanan.map(p => `${p.nama} x${p.jumlah} = Rp ${p.subtotal}`).join("\n")}

Total   : Rp ${trx.total}
Bayar   : Rp ${trx.bayar}
Kembali : Rp ${trx.kembali}

Terima kasih
</pre>`);
      win.document.close();
      win.print();
    }

    // Total hari ini
    async function loadTotalHariIni() {
      const today = new Date();
      const start = new Date(today.setHours(0,0,0,0)).toISOString();
      const end = new Date(today.setHours(23,59,59,999)).toISOString();

      let { data, error } = await supabase
        .from("transaksi")
        .select("total")
        .gte("tanggal", start)
        .lte("tanggal", end);

      if (error) {
        console.error("Error total hari ini:", error);
        return;
      }
      const sum = data.reduce((a,b) => a + b.total, 0);
      totalHariIni.textContent = sum;
    }

    // Init
    loadMenu();
    loadTotalHariIni();
  </script>
</body>
</html>
