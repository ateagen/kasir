<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kasir - Bunda Ana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-green-600 text-white p-4 text-center text-xl font-bold">
    Kasir - Bunda Ana
  </header>

  <!-- Total hari ini -->
  <div class="p-4">
    <div class="bg-white rounded-xl shadow p-4 text-center">
      <span class="font-semibold">Total Penjualan Hari Ini:</span>
      <span id="totalHariIni" class="text-green-600 font-bold">0</span>
    </div>
  </div>

  <!-- Grid Menu -->
  <main class="flex-1 p-4">
    <h2 class="text-lg font-bold mb-2">Menu</h2>
    <div id="menuGrid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
  </main>

  <!-- Pesanan -->
  <section class="bg-white p-4 shadow rounded-t-2xl">
    <h2 class="text-lg font-bold mb-2">Daftar Pesanan</h2>
    <ul id="daftarPesanan" class="mb-2"></ul>
    <div class="mb-2">Total: <span id="totalPesanan" class="font-bold">0</span></div>
    <div class="mb-2">
      Bayar: <input id="bayarInput" type="number" class="border p-1 w-32">
    </div>
    <div class="mb-2">Kembali: <span id="kembalian" class="font-bold">0</span></div>
    <div class="flex gap-2">
      <button id="btnBayar" class="bg-green-600 text-white px-4 py-2 rounded">Bayar</button>
      <button id="btnBatal" class="bg-red-600 text-white px-4 py-2 rounded">Batal</button>
      <a href="index.html" class="bg-gray-600 text-white px-4 py-2 rounded">Kembali</a>
    </div>
  </section>

  <script>
    const supabaseUrl = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

    const menuGrid = document.getElementById("menuGrid");
    const daftarPesananEl = document.getElementById("daftarPesanan");
    const totalPesananEl = document.getElementById("totalPesanan");
    const bayarInput = document.getElementById("bayarInput");
    const kembalianEl = document.getElementById("kembalian");
    const totalHariIniEl = document.getElementById("totalHariIni");

    let pesanan = [];

    // Ambil nama kasir dari localStorage
    const namaKasir = localStorage.getItem("kasir") || "Tanpa Nama";

    // Load menu
    async function loadMenu() {
      let { data, error } = await supabase.from("menu").select("*");
      if (error) {
        console.error("DEBUG MENU:", error);
        return;
      }

      menuGrid.innerHTML = "";
      data.forEach(item => {
        const div = document.createElement("div");
        div.className = "bg-white shadow rounded-xl p-4 text-center cursor-pointer hover:bg-green-100";
        div.innerHTML = `<div class="font-bold">${item.nama}</div>
                         <div>Rp ${item.harga}</div>`;
        div.onclick = () => tambahPesanan(item);
        menuGrid.appendChild(div);
      });
    }

    // Tambah pesanan
    function tambahPesanan(item) {
      let existing = pesanan.find(p => p.id === item.id);
      if (existing) {
        existing.jumlah++;
      } else {
        pesanan.push({ ...item, jumlah: 1 });
      }
      renderPesanan();
    }

    // Render pesanan
    function renderPesanan() {
      daftarPesananEl.innerHTML = "";
      let total = 0;
      pesanan.forEach(p => {
        let subtotal = p.harga * p.jumlah;
        total += subtotal;
        const li = document.createElement("li");
        li.textContent = `${p.nama} x${p.jumlah} = Rp ${subtotal}`;
        daftarPesananEl.appendChild(li);
      });
      totalPesananEl.textContent = total;
      hitungKembalian();
    }

    // Hitung kembalian
    function hitungKembalian() {
      const total = parseInt(totalPesananEl.textContent) || 0;
      const bayar = parseInt(bayarInput.value) || 0;
      kembalianEl.textContent = bayar - total;
    }

    bayarInput.addEventListener("input", hitungKembalian);

    // Bayar
    document.getElementById("btnBayar").addEventListener("click", async () => {
      if (pesanan.length === 0) return alert("Pesanan kosong!");
      const total = parseInt(totalPesananEl.textContent);
      const bayar = parseInt(bayarInput.value) || 0;
      const kembali = bayar - total;
      const tanggal = new Date().toISOString();

      // Simpan ke Supabase
      let { error } = await supabase.from("transaksi").insert([
        { total, bayar, kembali, tanggal, kasir: namaKasir }
      ]);
      if (error) return alert("Gagal simpan transaksi");

      cetakStruk(total, bayar, kembali);
      resetPesanan();
      loadTotalHariIni();
    });

    // Cetak struk (hanya daftar pesanan)
    function cetakStruk(total, bayar, kembali) {
      let w = window.open("", "Print", "width=300,height=600");
      let now = new Date().toLocaleString();
      let html = `
        <div style="width:250px;font-family:monospace">
          <h2 style="text-align:center">Bunda Ana</h2>
          <div style="text-align:center">Kasir: ${namaKasir}</div>
          <div>${now}</div>
          <hr>
          <ul>`;
      pesanan.forEach(p => {
        html += `<li>${p.nama} x${p.jumlah} = Rp ${p.harga * p.jumlah}</li>`;
      });
      html += `</ul>
          <hr>
          <div>Total: Rp ${total}</div>
          <div>Bayar: Rp ${bayar}</div>
          <div>Kembali: Rp ${kembali}</div>
          <hr>
          <div style="text-align:center">Terima Kasih</div>
        </div>`;
      w.document.write(html);
      w.print();
      w.close();
    }

    // Reset
    function resetPesanan() {
      pesanan = [];
      renderPesanan();
      bayarInput.value = "";
      hitungKembalian();
    }

    document.getElementById("btnBatal").onclick = resetPesanan;

    // Total hari ini
    async function loadTotalHariIni() {
      const todayStr = new Date().toISOString().split("T")[0]; // YYYY-MM-DD
      let { data, error } = await supabase.from("transaksi").select("total, tanggal");
      if (error) {
        console.error("Error total hari ini:", error);
        return;
      }
      const todayData = data.filter(t => (t.tanggal || "").startsWith(todayStr));
      const sum = todayData.reduce((a, b) => a + (b.total || 0), 0);
      totalHariIniEl.textContent = sum;
    }

    // Init
    loadMenu();
    loadTotalHariIni();
  </script>
</body>
</html>
