<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Halaman Kas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-4">
  <div class="max-w-4xl mx-auto bg-white shadow rounded-xl p-6 space-y-6">
    <h1 class="text-2xl font-bold text-center">Halaman Kas</h1>

    <!-- Tombol kembali -->
    <div class="text-center">
      <button onclick="kembaliKeIndex()" 
        class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
        Kembali ke Layar Utama
      </button>
    </div>

    <!-- Kas Awal & Akhir -->
    <section>
      <h2 class="text-xl font-semibold mb-2">Informasi Kas</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div class="p-4 border rounded bg-gray-50">
          <p class="font-medium">Kas Awal:</p>
          <p id="kasAwal" class="text-lg font-bold">Rp 0</p>
        </div>
        <div class="p-4 border rounded bg-gray-50">
          <p class="font-medium">Kas Akhir:</p>
          <p id="kasAkhir" class="text-lg font-bold">Rp 0</p>
        </div>
      </div>
    </section>

    <!-- Input Pengeluaran -->
    <section>
      <h2 class="text-xl font-semibold mb-2">Input Pengeluaran</h2>
      <div class="flex flex-col md:flex-row gap-2">
        <input id="ketPengeluaran" type="text" placeholder="Keterangan"
          class="border rounded p-2 flex-1" />
        <input id="biayaPengeluaran" type="number" placeholder="Jumlah"
          class="border rounded p-2 flex-1" />
        <button onclick="tambahPengeluaran()" 
          class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
          Simpan
        </button>
      </div>
      <table class="w-full mt-4 border text-sm">
        <thead>
          <tr class="bg-gray-200">
            <th class="border p-2">Tanggal</th>
            <th class="border p-2">Keterangan</th>
            <th class="border p-2">Jumlah</th>
          </tr>
        </thead>
        <tbody id="pengeluaranTable"></tbody>
      </table>
    </section>

    <!-- Total Penjualan Hari Ini -->
    <section>
      <h2 class="text-xl font-semibold mb-2">Total Penjualan Hari Ini</h2>
      <div class="p-4 border rounded bg-green-50">
        <p id="totalPenjualan" class="text-lg font-bold text-green-700">Rp 0</p>
      </div>
    </section>
  </div>

  <script>
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function kembaliKeIndex() {
      window.location.href = "index.html";
    }

    async function loadKas() {
      // Ambil kas akhir terakhir sebagai kas awal hari ini
      const { data: kasData } = await supabase
        .from("kas")
        .select("*")
        .order("tanggal", { ascending: false })
        .limit(1);

      let kasAwal = 0;
      if (kasData && kasData.length > 0) {
        kasAwal = kasData[0].kas_akhir;
      }
      document.getElementById("kasAwal").textContent = "Rp " + kasAwal;

      // Hitung kas akhir: kas awal + total penjualan - total pengeluaran
      const totalPenjualan = await getTotalPenjualanHariIni();
      const totalPengeluaran = await getTotalPengeluaranHariIni();
      const kasAkhir = kasAwal + totalPenjualan - totalPengeluaran;

      document.getElementById("kasAkhir").textContent = "Rp " + kasAkhir;

      // Simpan kas hari ini
      await supabase.from("kas").upsert([
        {
          tanggal: new Date().toISOString().split("T")[0],
          kas_awal: kasAwal,
          kas_akhir: kasAkhir,
        },
      ]);
    }

    async function tambahPengeluaran() {
      const keterangan = document.getElementById("ketPengeluaran").value.trim();
      const jumlah = parseFloat(document.getElementById("biayaPengeluaran").value);

      if (!keterangan || isNaN(jumlah)) return alert("Lengkapi data pengeluaran!");

      const { error } = await supabase.from("pengeluaran").insert([
        { tanggal: new Date().toISOString(), keterangan, jumlah },
      ]);

      if (error) return alert("Gagal simpan pengeluaran: " + error.message);

      document.getElementById("ketPengeluaran").value = "";
      document.getElementById("biayaPengeluaran").value = "";
      loadPengeluaran();
      loadKas();
    }

    async function loadPengeluaran() {
      const { data, error } = await supabase
        .from("pengeluaran")
        .select("*")
        .order("tanggal", { ascending: false });

      if (error) {
        alert("Gagal load pengeluaran: " + error.message);
        return;
      }

      const tbody = document.getElementById("pengeluaranTable");
      tbody.innerHTML = "";
      data.forEach((p) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border p-2">${new Date(p.tanggal).toLocaleString()}</td>
          <td class="border p-2">${p.keterangan}</td>
          <td class="border p-2">Rp ${p.jumlah}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function getTotalPenjualanHariIni() {
      const today = new Date().toISOString().split("T")[0];
      const { data, error } = await supabase
        .from("transaksi")
        .select("total, tanggal")
        .gte("tanggal", today + "T00:00:00")
        .lte("tanggal", today + "T23:59:59");

      if (error) {
        alert("Gagal load penjualan: " + error.message);
        return 0;
      }

      let total = 0;
      data.forEach((trx) => {
        total += trx.total;
      });

      document.getElementById("totalPenjualan").textContent = "Rp " + total;
      return total;
    }

    async function getTotalPengeluaranHariIni() {
      const today = new Date().toISOString().split("T")[0];
      const { data, error } = await supabase
        .from("pengeluaran")
        .select("jumlah, tanggal")
        .gte("tanggal", today + "T00:00:00")
        .lte("tanggal", today + "T23:59:59");

      if (error) {
        alert("Gagal load pengeluaran: " + error.message);
        return 0;
      }

      let total = 0;
      data.forEach((p) => {
        total += p.jumlah;
      });
      return total;
    }

    async function init() {
      await loadPengeluaran();
      await getTotalPenjualanHariIni();
      await loadKas();
    }

    init();
  </script>
</body>
</html>
