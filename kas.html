<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kas Harian - Resto Bunda Ana</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f8ff;
      margin: 0;
      padding: 0;
      color: #333;
    }
    header {
      background: #1e90ff;
      color: white;
      padding: 15px;
      text-align: center;
    }
    .container {
      max-width: 1000px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    }
    h2 {
      margin-bottom: 15px;
      color: #1e90ff;
    }
    .card {
      background: #e6f3ff;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input, button, textarea {
      padding: 8px;
      margin-bottom: 10px;
      width: 100%;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    button {
      background: #1e90ff;
      color: white;
      font-weight: bold;
      cursor: pointer;
      border: none;
    }
    button:hover {
      background: #187bcd;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 10px;
      text-align: center;
    }
    th {
      background: #1e90ff;
      color: white;
    }
    .loading {
      display: none;
      text-align: center;
      margin: 15px 0;
      color: #1e90ff;
      font-weight: bold;
    }
  </style>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Kas Harian - Resto Bunda Ana</h1>
  </header>

  <div class="container">
    <h2>Ringkasan Kas Hari Ini</h2>
    <div id="loading" class="loading">‚è≥ Loading...</div>
    <div class="card">
      <table>
        <tr>
          <th>Kas Awal</th>
          <th>Total Penjualan</th>
          <th>Total Pengeluaran</th>
          <th>Kas Akhir</th>
        </tr>
        <tr>
          <td id="kasAwal">Rp 0</td>
          <td id="penjualan">Rp 0</td>
          <td id="pengeluaran">Rp 0</td>
          <td id="kasAkhir">Rp 0</td>
        </tr>
      </table>
    </div>

    <h2>Tambah Pengeluaran</h2>
    <div class="card">
      <form id="formPengeluaran">
        <label>Deskripsi</label>
        <input type="text" id="deskripsi" required>
        <label>Jumlah</label>
        <input type="number" id="jumlah" required>
        <button type="submit">Simpan Pengeluaran</button>
      </form>
    </div>

    <h2>Rincian Pengeluaran Hari Ini</h2>
    <div class="card">
      <table>
        <thead>
          <tr>
            <th>Waktu</th>
            <th>Deskripsi</th>
            <th>Jumlah</th>
            <th>Kasir</th>
          </tr>
        </thead>
        <tbody id="tabelPengeluaran">
          <tr><td colspan="4">Belum ada data</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // kasir login disimpan di sessionStorage dari index.html
    const kasirId = sessionStorage.getItem("kasir_id");
    const kasirNama = sessionStorage.getItem("kasir_nama");

    const loading = document.getElementById("loading");
    const kasAwalEl = document.getElementById("kasAwal");
    const penjualanEl = document.getElementById("penjualan");
    const pengeluaranEl = document.getElementById("pengeluaran");
    const kasAkhirEl = document.getElementById("kasAkhir");
    const tabelPengeluaran = document.getElementById("tabelPengeluaran");

    async function loadKas() {
      loading.style.display = "block";
      const today = new Date().toISOString().split("T")[0];

      // === Ambil Kas Awal dari kas akhir kemarin ===
      const { data: kasKemarin } = await supabase
        .from("v_kas_harian")
        .select("*")
        .lt("tanggal", today)
        .order("tanggal", { ascending: false })
        .limit(1);

      let kasAwal = kasKemarin && kasKemarin.length > 0 ? kasKemarin[0].kas_akhir : 0;

      // === Hitung total penjualan hari ini ===
      const { data: penjualan } = await supabase
        .from("transaksi")
        .select("total")
        .gte("waktu", today)
        .lt("waktu", today + "T23:59:59");

      let totalPenjualan = penjualan ? penjualan.reduce((sum, row) => sum + parseFloat(row.total), 0) : 0;

      // === Hitung total pengeluaran hari ini ===
      const { data: pengeluaran } = await supabase
        .from("pengeluaran")
        .select("jumlah")
        .gte("waktu", today)
        .lt("waktu", today + "T23:59:59");

      let totalPengeluaran = pengeluaran ? pengeluaran.reduce((sum, row) => sum + parseFloat(row.jumlah), 0) : 0;

      // === Hitung kas akhir ===
      let kasAkhir = kasAwal + totalPenjualan - totalPengeluaran;

      // === Tampilkan ke HTML ===
      kasAwalEl.textContent = "Rp " + kasAwal.toLocaleString();
      penjualanEl.textContent = "Rp " + totalPenjualan.toLocaleString();
      pengeluaranEl.textContent = "Rp " + totalPengeluaran.toLocaleString();
      kasAkhirEl.textContent = "Rp " + kasAkhir.toLocaleString();

      // === Load rincian pengeluaran hari ini ===
      const { data: detail } = await supabase
        .from("pengeluaran")
        .select("waktu, deskripsi, jumlah, akun(username)")
        .gte("waktu", today)
        .lt("waktu", today + "T23:59:59")
        .order("waktu", { ascending: true });

      tabelPengeluaran.innerHTML = "";
      if (detail && detail.length > 0) {
        detail.forEach(d => {
          let tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${new Date(d.waktu).toLocaleTimeString()}</td>
            <td>${d.deskripsi}</td>
            <td>Rp ${parseFloat(d.jumlah).toLocaleString()}</td>
            <td>${d.akun?.username || "-"}</td>
          `;
          tabelPengeluaran.appendChild(tr);
        });
      } else {
        tabelPengeluaran.innerHTML = `<tr><td colspan="4">Belum ada data</td></tr>`;
      }

      loading.style.display = "none";
    }

    // Simpan pengeluaran baru
    document.getElementById("formPengeluaran").addEventListener("submit", async (e) => {
      e.preventDefault();
      loading.style.display = "block";

      const deskripsi = document.getElementById("deskripsi").value;
      const jumlah = parseFloat(document.getElementById("jumlah").value);

      await supabase.from("pengeluaran").insert([
        { deskripsi, jumlah, kasir_id: kasirId }
      ]);

      document.getElementById("formPengeluaran").reset();
      await loadKas();
    });

    loadKas();
  </script>
</body>
</html>
