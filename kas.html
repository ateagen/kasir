<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Kas - Bunda Ana</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 p-4">

  <div class="flex justify-between items-center mb-4">
    <h1 class="text-xl font-bold">Kas - Bunda Ana</h1>
    <a href="index.html" class="bg-gray-500 text-white px-3 py-1 rounded">Kembali</a>
  </div>

  <!-- Info kas -->
  <div class="bg-white p-4 rounded shadow mb-4">
    <p>Kas Awal: Rp <span id="kasAwal">0</span></p>
    <p>Total Penjualan Hari Ini: Rp <span id="penjualanHariIni">0</span></p>
    <p>Total Pengeluaran Hari Ini: Rp <span id="pengeluaranHariIni">0</span></p>
    <p>Kas Akhir: Rp <span id="kasAkhir">0</span></p>
  </div>

  <!-- Tambah Pengeluaran -->
  <div class="bg-white p-4 rounded shadow mb-4">
    <h2 class="font-semibold mb-2">Tambah Pengeluaran</h2>
    <input id="keteranganPengeluaran" placeholder="Keterangan" class="border p-1 mb-2 w-full">
    <input id="jumlahPengeluaran" type="number" placeholder="Jumlah" class="border p-1 mb-2 w-full">
    <button onclick="tambahPengeluaran()" class="bg-red-500 text-white px-3 py-1 rounded">Tambah</button>
  </div>

  <!-- Daftar Transaksi -->
  <div class="bg-white p-4 rounded shadow">
    <h2 class="font-semibold mb-2">Transaksi Hari Ini</h2>
    <table class="w-full border">
      <thead>
        <tr class="bg-gray-200">
          <th class="border p-1">Tanggal</th>
          <th class="border p-1">Kasir</th>
          <th class="border p-1">Total</th>
        </tr>
      </thead>
      <tbody id="tabelTransaksi"></tbody>
    </table>
  </div>

<script>
  const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  async function loadKas() {
    let today = new Date().toISOString().split("T")[0];

    // total penjualan
    let { data: penjualan, error } = await supabaseClient
      .from("transaksi")
      .select("total")
      .gte("created_at", today + "T00:00:00")
      .lte("created_at", today + "T23:59:59");

    let totalPenjualan = 0;
    if (!error && penjualan) {
      totalPenjualan = penjualan.reduce((sum, t) => sum + parseFloat(t.total), 0);
    }

    // total pengeluaran
    let { data: pengeluaran, error: err2 } = await supabaseClient
      .from("kas")
      .select("jumlah")
      .eq("tipe", "keluar")
      .gte("created_at", today + "T00:00:00")
      .lte("created_at", today + "T23:59:59");

    let totalPengeluaran = 0;
    if (!err2 && pengeluaran) {
      totalPengeluaran = pengeluaran.reduce((sum, k) => sum + parseFloat(k.jumlah), 0);
    }

    document.getElementById("kasAwal").innerText = "0"; // bisa diisi dari kas akhir kemarin
    document.getElementById("penjualanHariIni").innerText = totalPenjualan;
    document.getElementById("pengeluaranHariIni").innerText = totalPengeluaran;
    document.getElementById("kasAkhir").innerText = totalPenjualan - totalPengeluaran;
  }

  async function tambahPengeluaran() {
    const ket = document.getElementById("keteranganPengeluaran").value;
    const jumlah = parseInt(document.getElementById("jumlahPengeluaran").value);
    if (!ket || !jumlah) return alert("Lengkapi data!");

    let { error } = await supabaseClient.from("kas").insert([{ tipe: "keluar", keterangan: ket, jumlah }]);
    if (error) alert("Gagal tambah pengeluaran");
    loadKas();
  }

  async function loadTransaksi() {
    let today = new Date().toISOString().split("T")[0];

    let { data, error } = await supabaseClient
      .from("transaksi")
      .select("id, total, created_at, akun(nama)")
      .gte("created_at", today + "T00:00:00")
      .lte("created_at", today + "T23:59:59")
      .order("created_at", { ascending: false });

    if (error) {
      console.error(error);
      return;
    }

    const tbody = document.getElementById("tabelTransaksi");
    tbody.innerHTML = "";
    data.forEach(t => {
      let tr = document.createElement("tr");
      tr.innerHTML = `
        <td class="border p-1">${new Date(t.created_at).toLocaleTimeString()}</td>
        <td class="border p-1">${t.akun ? t.akun.nama : "-"}</td>
        <td class="border p-1">Rp ${t.total}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  loadKas();
  loadTransaksi();
</script>

</body>
</html>
