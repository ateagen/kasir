<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Kas Harian</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col items-center p-6">

  <h1 class="text-2xl font-bold text-blue-700 mb-6">ðŸ’° Kas Harian Resto Bunda Ana</h1>

  <div class="grid grid-cols-2 gap-4 w-full max-w-4xl">
    <!-- Ringkasan Kas -->
    <div class="bg-white shadow-md rounded-lg p-4">
      <h2 class="text-lg font-semibold text-blue-600 mb-2">Ringkasan</h2>
      <p id="kasAwal">Kas Awal: Rp 0</p>
      <p id="totalPenjualan">Total Penjualan: Rp 0</p>
      <p id="totalPengeluaran">Total Pengeluaran: Rp 0</p>
      <hr class="my-2">
      <p id="kasAkhir" class="font-bold text-blue-700">Kas Akhir: Rp 0</p>
    </div>

    <!-- Form Input Pengeluaran -->
    <div class="bg-white shadow-md rounded-lg p-4">
      <h2 class="text-lg font-semibold text-blue-600 mb-2">Input Pengeluaran</h2>
      <input type="text" id="deskripsi" placeholder="Deskripsi"
             class="border rounded p-2 w-full mb-2">
      <input type="number" id="jumlah" placeholder="Jumlah"
             class="border rounded p-2 w-full mb-2">
      <button onclick="tambahPengeluaran()"
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 w-full">
        Simpan
      </button>
    </div>
  </div>

  <!-- Tabel Pengeluaran -->
  <div class="bg-white shadow-md rounded-lg p-4 mt-6 w-full max-w-4xl">
    <h2 class="text-lg font-semibold text-blue-600 mb-2">Rincian Pengeluaran Hari Ini</h2>
    <table class="w-full border-collapse border border-gray-300 text-sm">
      <thead>
        <tr class="bg-blue-100">
          <th class="border p-2">Waktu</th>
          <th class="border p-2">Deskripsi</th>
          <th class="border p-2">Jumlah</th>
          <th class="border p-2">Kasir</th>
        </tr>
      </thead>
      <tbody id="tabelPengeluaran"></tbody>
    </table>
  </div>

  <script>
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...";
    const headers = { 
      "apikey": SUPABASE_KEY,
      "Authorization": "Bearer " + SUPABASE_KEY,
      "Content-Type": "application/json"
    };

    const user = JSON.parse(localStorage.getItem("user")); // { id, username, role }
    if (!user) {
      alert("Silakan login dulu!");
      window.location.href = "index.html";
    }

    async function loadKas() {
      const resKas = await fetch(`${SUPABASE_URL}/rest/v1/v_kas_harian?order=tanggal.desc&limit=2`, { headers });
      const dataKas = await resKas.json();
      const hariIni = dataKas[0] || {};
      const kemarin = dataKas[1] || {};

      document.getElementById("kasAwal").textContent = "Kas Awal: Rp " + (kemarin.kas_akhir || 0);
      document.getElementById("totalPenjualan").textContent = "Total Penjualan: Rp " + (hariIni.total_penjualan || 0);
      document.getElementById("totalPengeluaran").textContent = "Total Pengeluaran: Rp " + (hariIni.total_pengeluaran || 0);
      document.getElementById("kasAkhir").textContent = "Kas Akhir: Rp " + (hariIni.kas_akhir || 0);
    }

    async function loadPengeluaran() {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/pengeluaran?select=waktu,deskripsi,jumlah,akun(username)&order=waktu.desc`, { headers });
      const data = await res.json();
      const tbody = document.getElementById("tabelPengeluaran");
      tbody.innerHTML = "";
      data.forEach(p => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="border p-2">${new Date(p.waktu).toLocaleTimeString()}</td>
          <td class="border p-2">${p.deskripsi}</td>
          <td class="border p-2">Rp ${p.jumlah}</td>
          <td class="border p-2">${p.akun?.username || "-"}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function tambahPengeluaran() {
      const deskripsi = document.getElementById("deskripsi").value;
      const jumlah = parseInt(document.getElementById("jumlah").value);

      if (!deskripsi || !jumlah) {
        alert("Isi semua field!");
        return;
      }

      await fetch(`${SUPABASE_URL}/rest/v1/pengeluaran`, {
        method: "POST",
        headers,
        body: JSON.stringify({
          deskripsi,
          jumlah,
          kasir_id: user.id
        })
      });

      document.getElementById("deskripsi").value = "";
      document.getElementById("jumlah").value = "";

      loadKas();
      loadPengeluaran();
    }

    loadKas();
    loadPengeluaran();
  </script>

</body>
</html>
