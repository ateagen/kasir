<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Kas Harian</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-blue-50 min-h-screen">

  <!-- Popup Login -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-2xl shadow-xl w-80">
      <h2 class="text-xl font-bold mb-4 text-center text-blue-600">Login Kas</h2>
      <input id="username" type="text" placeholder="Username"
             class="w-full p-2 border rounded mb-2" />
      <input id="password" type="password" placeholder="Password"
             class="w-full p-2 border rounded mb-4" />
      <button onclick="login()"
              class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Login</button>
      <p id="loginError" class="text-red-500 text-sm mt-2 hidden">Login gagal. Periksa username/password.</p>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 flex justify-between items-center">
    <h1 class="text-lg font-bold">Kas Harian</h1>
    <button onclick="logout()" class="bg-red-500 px-3 py-1 rounded">Kembali</button>
  </header>

  <main class="p-4 space-y-6">

    <!-- Form Input Pengeluaran -->
    <section class="bg-white p-4 rounded-2xl shadow">
      <h2 class="text-lg font-semibold text-blue-600 mb-3">Input Pengeluaran</h2>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <input id="deskripsi" type="text" placeholder="Keterangan"
               class="p-2 border rounded" />
        <input id="jumlah" type="number" placeholder="Jumlah"
               class="p-2 border rounded" />
        <button onclick="tambahPengeluaran()"
                class="bg-blue-500 text-white rounded p-2 hover:bg-blue-600">Tambah</button>
      </div>
    </section>

    <!-- Tabel Pengeluaran -->
    <section class="bg-white p-4 rounded-2xl shadow">
      <h2 class="text-lg font-semibold text-blue-600 mb-3">Pengeluaran Hari Ini</h2>
      <div class="flex space-x-2 mb-3">
        <input type="date" id="pengeluaranMulai" class="border p-1 rounded" />
        <input type="date" id="pengeluaranAkhir" class="border p-1 rounded" />
        <button onclick="filterPengeluaran()"
                class="bg-blue-500 text-white px-3 rounded">Filter</button>
      </div>
      <div class="overflow-x-auto">
        <table class="w-full border text-sm">
          <thead class="bg-blue-100">
            <tr>
              <th class="border px-2 py-1">Tanggal</th>
              <th class="border px-2 py-1">Keterangan</th>
              <th class="border px-2 py-1">Jumlah</th>
              <th class="border px-2 py-1">Kasir</th>
            </tr>
          </thead>
          <tbody id="tabelPengeluaran"></tbody>
        </table>
      </div>
    </section>

    <!-- Ringkasan Kas -->
    <section class="bg-white p-4 rounded-2xl shadow space-y-2">
      <p><span class="font-semibold text-blue-600">Kas Awal:</span> Rp <span id="kasAwal">0</span></p>
      <p><span class="font-semibold text-blue-600">Total Penjualan Hari Ini:</span> Rp <span id="totalPenjualan">0</span></p>
      <p><span class="font-semibold text-blue-600">Total Pengeluaran Hari Ini:</span> Rp <span id="totalPengeluaran">0</span></p>
      <p><span class="font-semibold text-blue-600">Kas Akhir:</span> Rp <span id="kasAkhir">0</span></p>
    </section>

  </main>

  <script>
    const supabaseUrl = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const headers = { apikey: supabaseKey, Authorization: "Bearer " + supabaseKey };

    let currentUser = null;

    // ========== LOGIN ==========
    async function login() {
      const u = document.getElementById("username").value;
      const p = document.getElementById("password").value;
      const res = await fetch(`${supabaseUrl}/rest/v1/akun?username=eq.${u}&password=eq.${p}&select=*`, { headers });
      const data = await res.json();
      if (data.length > 0) {
        currentUser = data[0];
        localStorage.setItem("user", JSON.stringify(currentUser));
        document.getElementById("loginModal").classList.add("hidden");
        loadKas();
      } else {
        document.getElementById("loginError").classList.remove("hidden");
      }
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    function checkLogin() {
      const u = localStorage.getItem("user");
      if (!u) {
        document.getElementById("loginModal").classList.remove("hidden");
      } else {
        currentUser = JSON.parse(u);
        document.getElementById("loginModal").classList.add("hidden");
        loadKas();
      }
    }

    // ========== PENGELUARAN ==========
    async function tambahPengeluaran() {
      const deskripsi = document.getElementById("deskripsi").value;
      const jumlah = document.getElementById("jumlah").value;
      if (!deskripsi || !jumlah) {
        alert("Lengkapi data pengeluaran");
        return;
      }
      const body = { deskripsi, jumlah, kasir_id: currentUser.id };
      const res = await fetch(`${supabaseUrl}/rest/v1/pengeluaran`, {
        method: "POST",
        headers: { ...headers, "Content-Type": "application/json" },
        body: JSON.stringify(body),
      });
      if (res.ok) {
        document.getElementById("deskripsi").value = "";
        document.getElementById("jumlah").value = "";
        loadPengeluaran();
        loadKasRingkasan();
      }
    }

    async function loadPengeluaran(filter = "") {
      const res = await fetch(`${supabaseUrl}/rest/v1/pengeluaran?select=waktu,deskripsi,jumlah,akun(username)${filter}`, {
        headers,
      });
      const data = await res.json();
      const tbody = document.getElementById("tabelPengeluaran");
      tbody.innerHTML = "";
      let total = 0;
      data.forEach(r => {
        total += Number(r.jumlah);
        tbody.innerHTML += `
          <tr>
            <td class="border px-2 py-1">${new Date(r.waktu).toLocaleString()}</td>
            <td class="border px-2 py-1">${r.deskripsi}</td>
            <td class="border px-2 py-1">Rp ${r.jumlah}</td>
            <td class="border px-2 py-1">${r.akun?.username || "-"}</td>
          </tr>`;
      });
      document.getElementById("totalPengeluaran").textContent = total;
      hitungKasAkhir();
    }

    function filterPengeluaran() {
      const s = document.getElementById("pengeluaranMulai").value;
      const e = document.getElementById("pengeluaranAkhir").value;
      let f = "";
      if (s && e) f = `&waktu=gte.${s}T00:00:00&waktu=lte.${e}T23:59:59`;
      loadPengeluaran(f);
    }

    // ========== KAS ==========
    async function loadKas() {
      await loadPengeluaran();
      await loadKasRingkasan();
    }

    async function loadKasRingkasan() {
      // ambil kas akhir terakhir
      const res = await fetch(`${supabaseUrl}/rest/v1/v_kas_harian?select=tanggal,kas_akhir&order=tanggal.desc&limit=1`, { headers });
      const data = await res.json();
      const kasAwal = data.length > 0 ? data[0].kas_akhir : 0;
      document.getElementById("kasAwal").textContent = kasAwal;

      // total penjualan hari ini
      const today = new Date().toISOString().split("T")[0];
      const res2 = await fetch(`${supabaseUrl}/rest/v1/transaksi?select=total&waktu=gte.${today}T00:00:00&waktu=lte.${today}T23:59:59&kasir_id=eq.${currentUser.id}`, { headers });
      const data2 = await res2.json();
      let total = 0;
      data2.forEach(r => total += Number(r.total));
      document.getElementById("totalPenjualan").textContent = total;

      hitungKasAkhir();
    }

    function hitungKasAkhir() {
      const kasAwal = Number(document.getElementById("kasAwal").textContent) || 0;
      const penjualan = Number(document.getElementById("totalPenjualan").textContent) || 0;
      const pengeluaran = Number(document.getElementById("totalPengeluaran").textContent) || 0;
      document.getElementById("kasAkhir").textContent = kasAwal + penjualan - pengeluaran;
    }

    // ========== BACK BUTTON DEVICE ==========
    window.addEventListener("popstate", function () {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    });

    // init
    checkLogin();
  </script>
</body>
</html>
