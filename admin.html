<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - POS Kasir Resto Bunda Ana</title>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
  <style>
    body { font-family: Arial, sans-serif; margin:0; background:#f0f8ff; }
    header { background:#0077b6; color:white; padding:1rem; text-align:center; }
    main { padding:1rem; }
    h2 { color:#0077b6; margin-top:2rem; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; background:white; }
    th, td { border:1px solid #ccc; padding:8px; text-align:left; }
    th { background:#caf0f8; }
    button { background:#0077b6; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
    button:hover { background:#005f86; }
    form { margin-top:1rem; background:white; padding:1rem; border-radius:8px; box-shadow:0 2px 4px rgba(0,0,0,0.1); }
    input, select { padding:6px; margin:4px 0; width:100%; border:1px solid #ccc; border-radius:4px; }
    .popup { position:fixed; top:0; left:0; width:100%; height:100%; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.5); visibility:hidden; }
    .popup-content { background:white; padding:2rem; border-radius:8px; text-align:center; min-width:280px; }
    .visible { visibility:visible; }
  </style>
</head>
<body>
  <header>
    <h1>Admin Panel - POS Kasir Resto Bunda Ana</h1>
  </header>
  <main>
    <!-- Login Popup -->
    <div id="loginPopup" class="popup visible">
      <div class="popup-content">
        <h2>Login Admin</h2>
        <input type="text" id="loginUsername" placeholder="Username">
        <input type="password" id="loginPassword" placeholder="Password">
        <button onclick="loginAdmin()">Login</button>
      </div>
    </div>

    <!-- Loading Popup -->
    <div id="loadingPopup" class="popup">
      <div class="popup-content">
        <p>Loading...</p>
      </div>
    </div>

    <section id="adminContent" style="display:none;">
      <h2>Manajemen Akun</h2>
      <form id="formAkun">
        <input type="text" id="username" placeholder="Username" required>
        <input type="password" id="password" placeholder="Password" required>
        <select id="role" required>
          <option value="kasir">Kasir</option>
          <option value="admin">Admin</option>
        </select>
        <button type="submit">Tambah Akun</button>
      </form>
      <table id="akunTable">
        <thead>
          <tr><th>ID</th><th>Username</th><th>Role</th><th>Aksi</th></tr>
        </thead>
        <tbody></tbody>
      </table>

      <h2>Manajemen Menu</h2>
      <form id="formMenu">
        <input type="text" id="nama_menu" placeholder="Nama Menu" required>
        <input type="number" id="harga_menu" placeholder="Harga" required>
        <button type="submit">Tambah Menu</button>
      </form>
      <table id="menuTable">
        <thead>
          <tr><th>ID</th><th>Nama</th><th>Harga</th><th>Aksi</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

<script>
  // Supabase Config
  const SUPABASE_URL = "https://linujagdxugmocstckmd.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxpbnVqYWdkeHVnbW9jc3Rja21kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NDA2NDQsImV4cCI6MjA3MjExNjY0NH0.VWGFS7xy5_f2Iplxqn07HTnfWUIILbRYv4m_RV7YEHI";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const loginPopup = document.getElementById("loginPopup");
  const loadingPopup = document.getElementById("loadingPopup");
  const adminContent = document.getElementById("adminContent");

  function showLoading(){ loadingPopup.classList.add("visible"); }
  function hideLoading(){ loadingPopup.classList.remove("visible"); }

  // Login admin
  async function loginAdmin(){
    const username = document.getElementById("loginUsername").value.trim();
    const password = document.getElementById("loginPassword").value.trim();
    showLoading();
    const { data, error } = await supabase
      .from("akun")
      .select("*")
      .eq("username", username)
      .eq("password", password)
      .eq("role", "admin");
    hideLoading();

    console.log("DEBUG LOGIN:", {username, password, data, error});

    if (error) {
      alert("Error login: " + error.message);
      return;
    }
    if (!data || data.length === 0) {
      alert("Login gagal! Pastikan username, password, dan role=admin ada di tabel akun.");
      return;
    }

    sessionStorage.setItem("admin_logged_in", "true");
    loginPopup.style.display="none";
    adminContent.style.display="block";
    loadAkun();
    loadMenu();
  }

  // Cek session
  window.onload = () => {
    if(sessionStorage.getItem("admin_logged_in")==="true"){
      loginPopup.style.display="none";
      adminContent.style.display="block";
      loadAkun();
      loadMenu();
    }
  };

  // Logout otomatis saat tekan tombol back
  window.onpopstate = function(){
    sessionStorage.removeItem("admin_logged_in");
    window.location.href="index.html";
  };

  // Tambah Akun
  document.getElementById("formAkun").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const username=document.getElementById("username").value;
    const password=document.getElementById("password").value;
    const role=document.getElementById("role").value;
    if(!confirm("Yakin tambah akun?")) return;
    showLoading();
    const { error } = await supabase.from("akun").insert([{ username, password, role }]);
    hideLoading();
    if(error){ alert("Gagal tambah akun: " + error.message); }
    else { loadAkun(); e.target.reset(); }
  });

  async function loadAkun(){
    const tbody=document.querySelector("#akunTable tbody");
    tbody.innerHTML="";
    const { data, error } = await supabase.from("akun").select("*").order("id", {ascending:true});
    if(error){ console.error(error); return; }
    data.forEach(row=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${row.id}</td><td>${row.username}</td><td>${row.role}</td>
      <td><button onclick="hapusAkun(${row.id})">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
  }

  async function hapusAkun(id){
    if(!confirm("Yakin hapus akun ini?")) return;
    showLoading();
    await supabase.from("akun").delete().eq("id", id);
    hideLoading();
    loadAkun();
  }

  // Tambah Menu
  document.getElementById("formMenu").addEventListener("submit", async (e)=>{
    e.preventDefault();
    const nama=document.getElementById("nama_menu").value;
    const harga=parseInt(document.getElementById("harga_menu").value);
    if(!confirm("Yakin tambah menu?")) return;
    showLoading();
    const { error } = await supabase.from("menu").insert([{ nama, harga }]);
    hideLoading();
    if(error){ alert("Gagal tambah menu: " + error.message); }
    else { loadMenu(); e.target.reset(); }
  });

  async function loadMenu(){
    const tbody=document.querySelector("#menuTable tbody");
    tbody.innerHTML="";
    const { data, error } = await supabase.from("menu").select("*").order("id", {ascending:true});
    if(error){ console.error(error); return; }
    data.forEach(row=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${row.id}</td><td>${row.nama}</td><td>${row.harga}</td>
      <td><button onclick="hapusMenu(${row.id})">Hapus</button></td>`;
      tbody.appendChild(tr);
    });
  }

  async function hapusMenu(id){
    if(!confirm("Yakin hapus menu ini?")) return;
    showLoading();
    await supabase.from("menu").delete().eq("id", id);
    hideLoading();
    loadMenu();
  }
</script>
</body>
</html>
