<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";

    async function fetchData(endpoint, filter="") {
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}${filter}`, {
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`
        }
      });
      return await res.json();
    }

    async function insertData(endpoint, data) {
      document.getElementById("loading").classList.remove("hidden");
      const res = await fetch(`${SUPABASE_URL}/rest/v1/${endpoint}`, {
        method: "POST",
        headers: {
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          "Content-Type": "application/json",
          Prefer: "return=representation"
        },
        body: JSON.stringify(data)
      });
      document.getElementById("loading").classList.add("hidden");
      return await res.json();
    }
  </script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Loading Popup -->
  <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
      <p class="text-lg font-semibold">Loading...</p>
    </div>
  </div>

  <!-- Login Popup -->
  <div id="loginPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg w-80">
      <h2 class="text-xl font-bold mb-4">Login Admin</h2>
      <input id="username" type="text" placeholder="Username" class="w-full border p-2 mb-2 rounded">
      <input id="password" type="password" placeholder="Password" class="w-full border p-2 mb-4 rounded">
      <button onclick="login()" class="bg-blue-600 text-white px-4 py-2 rounded w-full">Login</button>
    </div>
  </div>

  <!-- Konten Admin -->
  <div id="content" class="hidden p-4 space-y-8">
    <h1 class="text-2xl font-bold text-center">Admin Panel</h1>

    <!-- Manajemen Akun -->
    <section class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Manajemen Akun</h2>
      <div class="flex gap-2 mb-4">
        <input id="newUser" type="text" placeholder="Username" class="border p-2 rounded">
        <input id="newPass" type="password" placeholder="Password" class="border p-2 rounded">
        <select id="newRole" class="border p-2 rounded">
          <option value="kasir">Kasir</option>
          <option value="admin">Admin</option>
        </select>
        <button onclick="addAkun()" class="bg-green-600 text-white px-4 py-2 rounded">Tambah</button>
      </div>
      <table class="w-full border text-sm" id="akunTable"></table>
    </section>

    <!-- Manajemen Menu -->
    <section class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Manajemen Menu</h2>
      <div class="flex gap-2 mb-4">
        <input id="newMenu" type="text" placeholder="Nama Menu" class="border p-2 rounded">
        <input id="newHarga" type="number" placeholder="Harga" class="border p-2 rounded">
        <button onclick="addMenu()" class="bg-green-600 text-white px-4 py-2 rounded">Tambah</button>
      </div>
      <table class="w-full border text-sm" id="menuTable"></table>
    </section>

    <!-- Semua Transaksi -->
    <section class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Semua Transaksi</h2>
      <div class="flex gap-2 mb-4">
        <input type="date" id="startDate" class="border p-2 rounded">
        <input type="date" id="endDate" class="border p-2 rounded">
        <button onclick="loadTransaksi()" class="bg-blue-600 text-white px-4 py-2 rounded">Filter</button>
        <button onclick="todayTransaksi()" class="bg-gray-600 text-white px-4 py-2 rounded">Hari Ini</button>
      </div>
      <table class="w-full border text-sm" id="transaksiTable"></table>
    </section>

    <!-- Kas Harian -->
    <section class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Kas Harian</h2>
      <table class="w-full border text-sm" id="kasTable"></table>
    </section>

    <!-- Rekap Penjualan per Kasir -->
    <section class="bg-white p-4 rounded-lg shadow">
      <h2 class="text-xl font-semibold mb-2">Rekap Penjualan per Kasir</h2>
      <table class="w-full border text-sm" id="rekapKasirTable"></table>
    </section>
  </div>

  <script>
    async function login() {
      const user = document.getElementById("username").value;
      const pass = document.getElementById("password").value;
      const data = await fetchData("akun", `?username=eq.${user}&password=eq.${pass}&role=eq.admin`);
      if (data.length > 0) {
        sessionStorage.setItem("adminLogin", "true");
        document.getElementById("loginPopup").classList.add("hidden");
        document.getElementById("content").classList.remove("hidden");
        loadAll();
      } else {
        alert("Login gagal!");
      }
    }

    function checkSession() {
      if (sessionStorage.getItem("adminLogin") === "true") {
        document.getElementById("loginPopup").classList.add("hidden");
        document.getElementById("content").classList.remove("hidden");
        loadAll();
      }
    }

    async function addAkun() {
      const username = document.getElementById("newUser").value;
      const password = document.getElementById("newPass").value;
      const role = document.getElementById("newRole").value;
      await insertData("akun", { username, password, role });
      loadAkun();
    }

    async function addMenu() {
      const nama = document.getElementById("newMenu").value;
      const harga = Number(document.getElementById("newHarga").value);
      await insertData("menu", { nama, harga });
      loadMenu();
    }

    async function loadAkun() {
      const data = await fetchData("akun");
      let html = "<tr><th class='border p-2'>ID</th><th class='border p-2'>Username</th><th class='border p-2'>Role</th></tr>";
      data.forEach(a => {
        html += `<tr><td class='border p-2'>${a.id}</td><td class='border p-2'>${a.username}</td><td class='border p-2'>${a.role}</td></tr>`;
      });
      document.getElementById("akunTable").innerHTML = html;
    }

    async function loadMenu() {
      const data = await fetchData("menu");
      let html = "<tr><th class='border p-2'>ID</th><th class='border p-2'>Nama</th><th class='border p-2'>Harga</th></tr>";
      data.forEach(m => {
        html += `<tr><td class='border p-2'>${m.id}</td><td class='border p-2'>${m.nama}</td><td class='border p-2'>${m.harga}</td></tr>`;
      });
      document.getElementById("menuTable").innerHTML = html;
    }

    async function loadTransaksi(start="", end="") {
      let filter = "";
      if (start && end) {
        filter = `?waktu=gte.${start}T00:00:00&waktu=lte.${end}T23:59:59`;
      }
      const data = await fetchData("v_transaksi_detail", filter);
      let html = "<tr><th class='border p-2'>ID</th><th class='border p-2'>Waktu</th><th class='border p-2'>Kasir</th><th class='border p-2'>Detail</th><th class='border p-2'>Total</th></tr>";
      data.forEach(t => {
        html += `<tr><td class='border p-2'>${t.id}</td><td class='border p-2'>${t.waktu}</td><td class='border p-2'>${t.kasir}</td><td class='border p-2'>${t.detail}</td><td class='border p-2'>${t.total}</td></tr>`;
      });
      document.getElementById("transaksiTable").innerHTML = html;
    }

    function todayTransaksi() {
      const today = new Date().toISOString().split("T")[0];
      loadTransaksi(today, today);
    }

    async function loadKas() {
      const data = await fetchData("v_kas_harian");
      let html = "<tr><th class='border p-2'>Tanggal</th><th class='border p-2'>Kas Awal</th><th class='border p-2'>Total Penjualan</th><th class='border p-2'>Total Pengeluaran</th><th class='border p-2'>Kas Akhir</th></tr>";
      data.forEach(k => {
        html += `<tr><td class='border p-2'>${k.tanggal}</td><td class='border p-2'>${k.kas_awal}</td><td class='border p-2'>${k.total_penjualan}</td><td class='border p-2'>${k.total_pengeluaran}</td><td class='border p-2'>${k.kas_akhir}</td></tr>`;
      });
      document.getElementById("kasTable").innerHTML = html;
    }

    async function loadRekapKasir() {
      const data = await fetchData("v_penjualan_per_kasir");
      let html = "<tr><th class='border p-2'>Tanggal</th><th class='border p-2'>Kasir</th><th class='border p-2'>Total Penjualan</th></tr>";
      data.forEach(r => {
        html += `<tr><td class='border p-2'>${r.tanggal}</td><td class='border p-2'>${r.kasir}</td><td class='border p-2'>${r.total_penjualan}</td></tr>`;
      });
      document.getElementById("rekapKasirTable").innerHTML = html;
    }

    function loadAll() {
      loadAkun();
      loadMenu();
      loadTransaksi();
      loadKas();
      loadRekapKasir();
    }

    checkSession();
  </script>
</body>
</html>
