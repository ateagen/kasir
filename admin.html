<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin POS Kasir</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- Modal Login -->
  <div id="loginModal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Login Admin</h2>
      <input id="username" type="text" placeholder="Username" class="w-full p-2 border rounded mb-3">
      <input id="password" type="password" placeholder="Password" class="w-full p-2 border rounded mb-3">
      <button onclick="handleLogin()" class="w-full bg-blue-600 text-white py-2 rounded">Login</button>
    </div>
  </div>

  <!-- Header -->
  <header class="bg-blue-700 text-white p-4 flex justify-between items-center">
    <h1 class="text-xl font-bold">Dashboard Admin</h1>
    <button onclick="handleLogout()" class="bg-red-500 px-4 py-2 rounded">Logout</button>
  </header>

  <main class="p-6 space-y-10">

    <!-- CRUD User -->
    <section class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-lg font-bold mb-4">Kelola User</h2>
      <div class="flex space-x-2 mb-4">
        <input id="newUsername" placeholder="Username" class="p-2 border rounded w-1/3">
        <input id="newPassword" placeholder="Password" type="password" class="p-2 border rounded w-1/3">
        <select id="newRole" class="p-2 border rounded w-1/3">
          <option value="admin">Admin</option>
          <option value="kasir">Kasir</option>
        </select>
        <button onclick="addUser()" class="bg-green-600 text-white px-4 py-2 rounded">Tambah</button>
      </div>
      <table class="w-full border text-sm" id="userTable">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">ID</th>
            <th class="p-2 border">Username</th>
            <th class="p-2 border">Role</th>
            <th class="p-2 border">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- CRUD Barang -->
    <section class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-lg font-bold mb-4">Kelola Barang</h2>
      <div class="flex space-x-2 mb-4">
        <input id="newNamaBarang" placeholder="Nama Barang" class="p-2 border rounded w-1/3">
        <input id="newHargaBarang" placeholder="Harga" type="number" class="p-2 border rounded w-1/3">
        <input id="newStokBarang" placeholder="Stok" type="number" class="p-2 border rounded w-1/3">
        <button onclick="addBarang()" class="bg-green-600 text-white px-4 py-2 rounded">Tambah</button>
      </div>
      <table class="w-full border text-sm" id="barangTable">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">ID</th>
            <th class="p-2 border">Nama</th>
            <th class="p-2 border">Harga</th>
            <th class="p-2 border">Stok</th>
            <th class="p-2 border">Aksi</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <!-- Transaksi -->
    <section class="bg-white p-6 rounded-lg shadow">
      <h2 class="text-lg font-bold mb-4">Daftar Transaksi</h2>
      <div class="flex items-center space-x-2 mb-4">
        <input type="date" id="filterTanggal" class="p-2 border rounded">
        <button onclick="loadTransaksi()" class="bg-blue-600 text-white px-4 py-2 rounded">Filter</button>
      </div>
      <table class="w-full border text-sm" id="transaksiTable">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">ID</th>
            <th class="p-2 border">Tanggal</th>
            <th class="p-2 border">Jenis</th>
            <th class="p-2 border">Jumlah</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

  </main>

  <!-- Konfigurasi Supabase -->
  <script>
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co"; // ganti dengan project URL
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY"; // ganti dengan anon key
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
  </script>

  <!-- Script Login & CRUD -->
  <script>
    // Cek session saat load
    window.onload = async () => {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) {
        document.getElementById("loginModal").classList.remove("hidden");
      } else if (user.role !== "admin") {
        alert("Akses ditolak. Hanya admin yang bisa masuk!");
        localStorage.removeItem("user");
        window.location.href = "index.html";
      } else {
        document.getElementById("loginModal").classList.add("hidden");
        loadUsers();
        loadBarang();
        loadTransaksi();
      }
    };

    // Login
    async function handleLogin() {
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;

      const { data, error } = await supabase
        .from("users")
        .select("*")
        .eq("username", username)
        .eq("password", password)
        .single();

      if (error || !data) {
        alert("Akun tidak dikenali. Anda akan kembali ke halaman awal.");
        window.location.href = "index.html";
      } else if (data.role !== "admin") {
        alert("Akses ditolak. Hanya admin yang bisa masuk!");
        window.location.href = "index.html";
      } else {
        localStorage.setItem("user", JSON.stringify(data));
        document.getElementById("loginModal").classList.add("hidden");
        loadUsers();
        loadBarang();
        loadTransaksi();
      }
    }

    // Logout
    function handleLogout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    // CRUD User
    async function loadUsers() {
      const { data } = await supabase.from("users").select("*");
      const tbody = document.querySelector("#userTable tbody");
      tbody.innerHTML = "";
      data.forEach(u => {
        tbody.innerHTML += `
          <tr>
            <td class="border p-2">${u.id}</td>
            <td class="border p-2">${u.username}</td>
            <td class="border p-2">${u.role}</td>
            <td class="border p-2">
              <button onclick="deleteUser(${u.id})" class="bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
            </td>
          </tr>
        `;
      });
    }

    async function addUser() {
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;
      await supabase.from("users").insert([{ username, password, role }]);
      loadUsers();
    }

    async function deleteUser(id) {
      await supabase.from("users").delete().eq("id", id);
      loadUsers();
    }

    // CRUD Barang
    async function loadBarang() {
      const { data } = await supabase.from("barang").select("*");
      const tbody = document.querySelector("#barangTable tbody");
      tbody.innerHTML = "";
      data.forEach(b => {
        tbody.innerHTML += `
          <tr>
            <td class="border p-2">${b.id}</td>
            <td class="border p-2">${b.nama}</td>
            <td class="border p-2">${b.harga}</td>
            <td class="border p-2">${b.stok}</td>
            <td class="border p-2">
              <button onclick="deleteBarang(${b.id})" class="bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
            </td>
          </tr>
        `;
      });
    }

    async function addBarang() {
      const nama = document.getElementById("newNamaBarang").value;
      const harga = document.getElementById("newHargaBarang").value;
      const stok = document.getElementById("newStokBarang").value;
      await supabase.from("barang").insert([{ nama, harga, stok }]);
      loadBarang();
    }

    async function deleteBarang(id) {
      await supabase.from("barang").delete().eq("id", id);
      loadBarang();
    }

    // Transaksi
    async function loadTransaksi() {
      const tgl = document.getElementById("filterTanggal").value;
      let query = supabase.from("transaksi").select("*");
      if (tgl) query = query.eq("tanggal", tgl);
      const { data } = await query;
      const tbody = document.querySelector("#transaksiTable tbody");
      tbody.innerHTML = "";
      data.forEach(t => {
        tbody.innerHTML += `
          <tr>
            <td class="border p-2">${t.id}</td>
            <td class="border p-2">${t.tanggal}</td>
            <td class="border p-2">${t.jenis}</td>
            <td class="border p-2">${t.jumlah}</td>
          </tr>
        `;
      });
    }
  </script>
</body>
</html>
