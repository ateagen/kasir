<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin POS Kasir</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-2xl font-bold text-center mb-6">Halaman Admin</h1>

  <!-- Loading Popup -->
  <div id="loadingPopup" class="hidden fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
    <div class="bg-white p-6 rounded-xl shadow-lg">
      <p class="text-lg font-semibold">Loading...</p>
    </div>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
    <!-- Manajemen Akun -->
    <div class="bg-white p-4 rounded-xl shadow">
      <h2 class="text-xl font-semibold mb-4">Manajemen Akun</h2>
      <form id="formAkun" class="space-y-2">
        <input id="username" type="text" placeholder="Username" class="w-full p-2 border rounded" required>
        <input id="password" type="password" placeholder="Password" class="w-full p-2 border rounded" required>
        <select id="role" class="w-full p-2 border rounded" required>
          <option value="admin">Admin</option>
          <option value="kasir">Kasir</option>
        </select>
        <button type="submit" class="bg-blue-500 text-white px-4 py-2 rounded w-full">Tambah Akun</button>
      </form>
      <table class="w-full mt-4 border">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">ID</th>
            <th class="p-2 border">Username</th>
            <th class="p-2 border">Role</th>
            <th class="p-2 border">Aksi</th>
          </tr>
        </thead>
        <tbody id="akunTable"></tbody>
      </table>
    </div>

    <!-- Manajemen Menu -->
    <div class="bg-white p-4 rounded-xl shadow">
      <h2 class="text-xl font-semibold mb-4">Manajemen Menu</h2>
      <form id="formMenu" class="space-y-2">
        <input id="nama_menu" type="text" placeholder="Nama Menu" class="w-full p-2 border rounded" required>
        <input id="harga" type="number" placeholder="Harga" class="w-full p-2 border rounded" required>
        <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded w-full">Tambah Menu</button>
      </form>
      <table class="w-full mt-4 border">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">ID</th>
            <th class="p-2 border">Nama Menu</th>
            <th class="p-2 border">Harga</th>
            <th class="p-2 border">Aksi</th>
          </tr>
        </thead>
        <tbody id="menuTable"></tbody>
      </table>
    </div>

    <!-- Tabel Transaksi -->
    <div class="bg-white p-4 rounded-xl shadow overflow-x-auto">
      <h2 class="text-xl font-semibold mb-4">Transaksi</h2>
      <table class="w-full border text-sm">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">ID</th>
            <th class="p-2 border">Tanggal</th>
            <th class="p-2 border">Kasir</th>
            <th class="p-2 border">Total</th>
          </tr>
        </thead>
        <tbody id="transaksiTable"></tbody>
      </table>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loadingPopup = document.getElementById("loadingPopup");
    function showLoading(show) {
      loadingPopup.classList.toggle("hidden", !show);
    }

    // ===== Akun =====
    const formAkun = document.getElementById("formAkun");
    const akunTable = document.getElementById("akunTable");

    formAkun.addEventListener("submit", async (e) => {
      e.preventDefault();
      showLoading(true);
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const role = document.getElementById("role").value;

      const { error } = await supabaseClient.from("akun").insert([{ username, password, role }]);
      showLoading(false);
      if (error) return alert("Gagal tambah akun: " + error.message);
      formAkun.reset();
      loadAkun();
    });

    async function loadAkun() {
      const { data, error } = await supabaseClient.from("akun").select("*").order("id", { ascending: false });
      if (error) return console.error(error);
      akunTable.innerHTML = data.map(a => `
        <tr>
          <td class="p-2 border">${a.id}</td>
          <td class="p-2 border">${a.username}</td>
          <td class="p-2 border">${a.role}</td>
          <td class="p-2 border">
            <button data-id="${a.id}" class="hapus-akun bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
          </td>
        </tr>
      `).join("");
      // pasang event listener setelah render
      document.querySelectorAll(".hapus-akun").forEach(btn => {
        btn.addEventListener("click", () => hapusAkun(btn.dataset.id));
      });
    }

    async function hapusAkun(id) {
      showLoading(true);
      const { error } = await supabaseClient.from("akun").delete().eq("id", id);
      showLoading(false);
      if (error) return alert("Gagal hapus akun: " + error.message);
      loadAkun();
    }

    // ===== Menu =====
    const formMenu = document.getElementById("formMenu");
    const menuTable = document.getElementById("menuTable");

    formMenu.addEventListener("submit", async (e) => {
      e.preventDefault();
      showLoading(true);
      const nama_menu = document.getElementById("nama_menu").value;
      const harga = document.getElementById("harga").value;

      const { error } = await supabaseClient.from("menu").insert([{ nama_menu, harga }]);
      showLoading(false);
      if (error) return alert("Gagal tambah menu: " + error.message);
      formMenu.reset();
      loadMenu();
    });

    async function loadMenu() {
      const { data, error } = await supabaseClient.from("menu").select("*").order("id", { ascending: false });
      if (error) return console.error(error);
      menuTable.innerHTML = data.map(m => `
        <tr>
          <td class="p-2 border">${m.id}</td>
          <td class="p-2 border">${m.nama_menu}</td>
          <td class="p-2 border">Rp ${m.harga}</td>
          <td class="p-2 border">
            <button data-id="${m.id}" class="hapus-menu bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
          </td>
        </tr>
      `).join("");
      // pasang event listener setelah render
      document.querySelectorAll(".hapus-menu").forEach(btn => {
        btn.addEventListener("click", () => hapusMenu(btn.dataset.id));
      });
    }

    async function hapusMenu(id) {
      showLoading(true);
      const { error } = await supabaseClient.from("menu").delete().eq("id", id);
      showLoading(false);
      if (error) return alert("Gagal hapus menu: " + error.message);
      loadMenu();
    }

    // ===== Transaksi =====
    const transaksiTable = document.getElementById("transaksiTable");

    async function loadTransaksi() {
      const { data, error } = await supabaseClient
        .from("transaksi")
        .select("id, tanggal, total, akun(username)")
        .order("tanggal", { ascending: false });

      if (error) return console.error(error);

      transaksiTable.innerHTML = data.map(t => `
        <tr>
          <td class="p-2 border">${t.id}</td>
          <td class="p-2 border">${t.tanggal}</td>
          <td class="p-2 border">${t.akun?.username || "-"}</td>
          <td class="p-2 border">Rp ${t.total}</td>
        </tr>
      `).join("");
    }

    // Load semua data saat halaman dibuka
    loadAkun();
    loadMenu();
    loadTransaksi();
  </script>
</body>
</html>
