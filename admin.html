<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin - Kasir Resto Bunda Ana</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #e0f7fa, #bbdefb);
      color: #333;
    }
    header {
      background: #2196f3;
      color: #fff;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2);
    }
    header h1 {
      margin: 0;
      font-size: 22px;
    }
    button.logout {
      background: #f44336;
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      color: #fff;
      font-weight: bold;
      transition: background 0.3s;
    }
    button.logout:hover { background: #d32f2f; }

    .container {
      padding: 20px;
      max-width: 1200px;
      margin: auto;
    }
    .section {
      background: #fff;
      padding: 20px;
      margin-bottom: 25px;
      border-radius: 10px;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    .section h2 {
      margin-top: 0;
      color: #1565c0;
      border-bottom: 2px solid #90caf9;
      padding-bottom: 6px;
    }

    input, select {
      padding: 8px;
      margin: 6px 4px;
      border: 1px solid #90caf9;
      border-radius: 6px;
      outline: none;
      transition: border 0.3s;
    }
    input:focus {
      border: 1px solid #1565c0;
    }

    button {
      padding: 8px 14px;
      margin: 6px 4px;
      border: none;
      border-radius: 6px;
      background: #2196f3;
      color: #fff;
      cursor: pointer;
      font-weight: bold;
      transition: background 0.3s, transform 0.2s;
    }
    button:hover {
      background: #1976d2;
      transform: scale(1.05);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    th {
      background: #2196f3;
      color: #fff;
      padding: 10px;
      text-align: left;
    }
    td {
      padding: 10px;
      border-bottom: 1px solid #e0e0e0;
    }
    tr:nth-child(even) {
      background: #f1faff;
    }
    tr:hover {
      background: #e3f2fd;
    }

    /* Loading overlay */
    #loading {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255,255,255,0.8);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 9999;
    }
    .spinner {
      border: 6px solid #e3f2fd;
      border-top: 6px solid #2196f3;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <header>
    <h1>Admin Panel - Resto Bunda Ana</h1>
    <button class="logout" onclick="logout()">Logout</button>
  </header>

  <div class="container">
    <!-- Manajemen Akun -->
    <div class="section">
      <h2>Manajemen Akun</h2>
      <input type="text" id="newUser" placeholder="Username">
      <input type="password" id="newPass" placeholder="Password">
      <button onclick="addUser()">Tambah Kasir</button>
      <table>
        <thead><tr><th>ID</th><th>Username</th><th>Role</th><th>Aksi</th></tr></thead>
        <tbody id="akunTable"></tbody>
      </table>
    </div>

    <!-- Manajemen Menu -->
    <div class="section">
      <h2>Manajemen Menu</h2>
      <input type="text" id="menuNama" placeholder="Nama Menu">
      <input type="number" id="menuHarga" placeholder="Harga">
      <button onclick="addMenu()">Tambah Menu</button>
      <table>
        <thead><tr><th>ID</th><th>Nama</th><th>Harga</th><th>Aksi</th></tr></thead>
        <tbody id="menuTable"></tbody>
      </table>
    </div>

    <!-- Transaksi -->
    <div class="section">
      <h2>Transaksi</h2>
      <input type="date" id="filterTanggal" onchange="loadTransaksi()">
      <table>
        <thead><tr><th>ID</th><th>Waktu</th><th>Total</th><th>Kasir</th><th>Detail</th></tr></thead>
        <tbody id="trxTable"></tbody>
      </table>
    </div>

    <!-- Kas Harian -->
    <div class="section">
      <h2>Kas Harian</h2>
      <input type="date" id="kasTanggal" onchange="loadKas()">
      <table>
        <thead><tr><th>Tanggal</th><th>Kas Awal</th><th>Total Penjualan</th><th>Total Pengeluaran</th><th>Kas Akhir</th></tr></thead>
        <tbody id="kasTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loading"><div class="spinner"></div></div>

  <script>
    // Konfigurasi Supabase
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Cek session
    const user = JSON.parse(localStorage.getItem("user"));
    if (!user || user.role !== "admin") {
      window.location.href = "index.html";
    }

    async function logout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    function showLoading() { document.getElementById("loading").style.display = "flex"; }
    function hideLoading() { document.getElementById("loading").style.display = "none"; }

    // ========================
    // Manajemen Akun
    // ========================
    async function loadAkun() {
      const { data, error } = await supabase.from("akun").select("id, username, role");
      if (error) return;
      const tbody = document.getElementById("akunTable");
      tbody.innerHTML = "";
      data.forEach(a => {
        tbody.innerHTML += `<tr>
          <td>${a.id}</td>
          <td>${a.username}</td>
          <td>${a.role}</td>
          <td><button onclick="deleteUser(${a.id})">Hapus</button></td>
        </tr>`;
      });
    }

    async function addUser() {
      const username = document.getElementById("newUser").value;
      const password = document.getElementById("newPass").value;
      if (!username || !password) return alert("Isi semua field!");
      showLoading();
      await supabase.from("akun").insert([{ username, password, role: "kasir" }]);
      hideLoading();
      document.getElementById("newUser").value = "";
      document.getElementById("newPass").value = "";
      loadAkun();
    }

    async function deleteUser(id) {
      showLoading();
      await supabase.from("akun").delete().eq("id", id);
      hideLoading();
      loadAkun();
    }

    // ========================
    // Manajemen Menu
    // ========================
    async function loadMenu() {
      const { data, error } = await supabase.from("menu").select("id, nama, harga");
      if (error) return;
      const tbody = document.getElementById("menuTable");
      tbody.innerHTML = "";
      data.forEach(m => {
        tbody.innerHTML += `<tr>
          <td>${m.id}</td>
          <td>${m.nama}</td>
          <td>${m.harga}</td>
          <td><button onclick="deleteMenu(${m.id})">Hapus</button></td>
        </tr>`;
      });
    }

    async function addMenu() {
      const nama = document.getElementById("menuNama").value;
      const harga = document.getElementById("menuHarga").value;
      if (!nama || !harga) return alert("Isi semua field!");
      showLoading();
      await supabase.from("menu").insert([{ nama, harga }]);
      hideLoading();
      document.getElementById("menuNama").value = "";
      document.getElementById("menuHarga").value = "";
      loadMenu();
    }

    async function deleteMenu(id) {
      showLoading();
      await supabase.from("menu").delete().eq("id", id);
      hideLoading();
      loadMenu();
    }

    // ========================
    // Transaksi
    // ========================
    async function loadTransaksi() {
      let tanggal = document.getElementById("filterTanggal").value;
      let query = supabase.from("v_transaksi_detail").select("*").order("waktu", { ascending: false });
      if (tanggal) query = query.gte("waktu", tanggal).lt("waktu", tanggal + "T23:59:59");
      const { data, error } = await query;
      if (error) return;
      const tbody = document.getElementById("trxTable");
      tbody.innerHTML = "";
      data.forEach(t => {
        tbody.innerHTML += `<tr>
          <td>${t.id}</td>
          <td>${new Date(t.waktu).toLocaleString()}</td>
          <td>${t.total}</td>
          <td>${t.kasir}</td>
          <td>${t.detail}</td>
        </tr>`;
      });
    }

    // ========================
    // Kas Harian
    // ========================
    async function loadKas() {
      let tanggal = document.getElementById("kasTanggal").value;
      let query = supabase.from("v_kas_harian").select("*");
      if (tanggal) query = query.eq("tanggal", tanggal);
      const { data, error } = await query;
      if (error) return;
      const tbody = document.getElementById("kasTable");
      tbody.innerHTML = "";
      data.forEach(k => {
        tbody.innerHTML += `<tr>
          <td>${k.tanggal}</td>
          <td>${k.kas_awal}</td>
          <td>${k.total_penjualan}</td>
          <td>${k.total_pengeluaran}</td>
          <td>${k.kas_akhir}</td>
        </tr>`;
      });
    }

    // Load awal
    loadAkun();
    loadMenu();
    loadTransaksi();
    loadKas();
  </script>
</body>
</html>
