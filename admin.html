<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin POS Kasir</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-gray-100 min-h-screen p-6">
  <h1 class="text-2xl font-bold mb-4">Halaman Admin</h1>

  <!-- Loading Overlay -->
  <div id="loading" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center z-50">
    <div class="bg-white p-4 rounded shadow text-lg">Loading...</div>
  </div>

  <!-- Grid -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- Manajemen Akun -->
    <div class="bg-white rounded-xl shadow p-4">
      <h2 class="font-bold text-lg mb-2">Manajemen Akun</h2>
      <form id="form-akun" class="space-y-2 mb-4">
        <input type="text" id="username" placeholder="Username" class="border p-2 w-full rounded" required>
        <input type="password" id="password" placeholder="Password" class="border p-2 w-full rounded" required>
        <select id="role" class="border p-2 w-full rounded" required>
          <option value="admin">Admin</option>
          <option value="kasir">Kasir</option>
        </select>
        <button class="bg-blue-500 text-white px-4 py-2 rounded">Tambah Akun</button>
      </form>
      <table class="w-full border">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">ID</th>
            <th class="p-2 border">Username</th>
            <th class="p-2 border">Role</th>
            <th class="p-2 border">Aksi</th>
          </tr>
        </thead>
        <tbody id="akunTable"></tbody>
      </table>
    </div>

    <!-- Manajemen Menu -->
    <div class="bg-white rounded-xl shadow p-4">
      <h2 class="font-bold text-lg mb-2">Manajemen Menu</h2>
      <form id="form-menu" class="space-y-2 mb-4">
        <input type="text" id="nama-menu" placeholder="Nama Menu" class="border p-2 w-full rounded" required>
        <input type="number" id="harga-menu" placeholder="Harga" class="border p-2 w-full rounded" required>
        <button class="bg-green-500 text-white px-4 py-2 rounded">Tambah Menu</button>
      </form>
      <table class="w-full border">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2 border">ID</th>
            <th class="p-2 border">Nama</th>
            <th class="p-2 border">Harga</th>
            <th class="p-2 border">Aksi</th>
          </tr>
        </thead>
        <tbody id="menuTable"></tbody>
      </table>
    </div>
  </div>

  <!-- Transaksi -->
  <div class="bg-white rounded-xl shadow p-4 mt-6">
    <h2 class="font-bold text-lg mb-2">Data Transaksi</h2>
    <table class="w-full border">
      <thead>
        <tr class="bg-gray-200">
          <th class="p-2 border">ID</th>
          <th class="p-2 border">Tanggal</th>
          <th class="p-2 border">Kasir</th>
          <th class="p-2 border">Menu</th>
          <th class="p-2 border">Jumlah</th>
          <th class="p-2 border">Total</th>
        </tr>
      </thead>
      <tbody id="transaksiTable"></tbody>
    </table>
  </div>

  <script>
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const akunTable = document.getElementById("akunTable");
    const menuTable = document.getElementById("menuTable");
    const transaksiTable = document.getElementById("transaksiTable");
    const loading = document.getElementById("loading");

    function showLoading(show = true) {
      loading.classList.toggle("hidden", !show);
    }

    // ==================== AKUN ====================
    async function loadAkun() {
      const { data, error } = await supabaseClient.from("users").select("id, username, role").order("created_at", { ascending: false });
      if (error) return console.error(error);

      akunTable.innerHTML = data.map(u => `
        <tr>
          <td class="p-2 border">${u.id}</td>
          <td class="p-2 border">${u.username}</td>
          <td class="p-2 border">${u.role}</td>
          <td class="p-2 border">
            <button data-id="${u.id}" class="hapus-akun bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
          </td>
        </tr>
      `).join("");

      document.querySelectorAll(".hapus-akun").forEach(btn => {
        btn.addEventListener("click", () => hapusAkun(btn.dataset.id));
      });
    }

    async function hapusAkun(id) {
      showLoading(true);
      const { error } = await supabaseClient.from("users").delete().eq("id", id);
      showLoading(false);
      if (error) return alert("Gagal hapus akun: " + error.message);
      loadAkun();
    }

    document.getElementById("form-akun").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const role = document.getElementById("role").value;
      showLoading(true);
      const { error } = await supabaseClient.from("users").insert([{ username, password, role }]);
      showLoading(false);
      if (error) return alert("Gagal tambah akun: " + error.message);
      e.target.reset();
      loadAkun();
    });

    // ==================== MENU ====================
    async function loadMenu() {
      const { data, error } = await supabaseClient.from("menu").select("*").order("created_at", { ascending: false });
      if (error) return console.error(error);

      menuTable.innerHTML = data.map(m => `
        <tr>
          <td class="p-2 border">${m.id}</td>
          <td class="p-2 border">${m.nama}</td>
          <td class="p-2 border">Rp ${m.harga}</td>
          <td class="p-2 border">
            <button data-id="${m.id}" class="hapus-menu bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
          </td>
        </tr>
      `).join("");

      document.querySelectorAll(".hapus-menu").forEach(btn => {
        btn.addEventListener("click", () => hapusMenu(btn.dataset.id));
      });
    }

    async function hapusMenu(id) {
      showLoading(true);
      const { error } = await supabaseClient.from("menu").delete().eq("id", id);
      showLoading(false);
      if (error) return alert("Gagal hapus menu: " + error.message);
      loadMenu();
    }

    document.getElementById("form-menu").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nama = document.getElementById("nama-menu").value;
      const harga = document.getElementById("harga-menu").value;
      showLoading(true);
      const { error } = await supabaseClient.from("menu").insert([{ nama, harga }]);
      showLoading(false);
      if (error) return alert("Gagal tambah menu: " + error.message);
      e.target.reset();
      loadMenu();
    });

    // ==================== TRANSAKSI ====================
    async function loadTransaksi() {
      const { data, error } = await supabaseClient
        .from("transaksi")
        .select("id, tanggal, jumlah, total_harga, users(username), menu(nama)")
        .order("tanggal", { ascending: false });
      if (error) return console.error(error);

      transaksiTable.innerHTML = data.map(t => `
        <tr>
          <td class="p-2 border">${t.id}</td>
          <td class="p-2 border">${new Date(t.tanggal).toLocaleString()}</td>
          <td class="p-2 border">${t.users?.username || "-"}</td>
          <td class="p-2 border">${t.menu?.nama || "-"}</td>
          <td class="p-2 border">${t.jumlah}</td>
          <td class="p-2 border">Rp ${t.total_harga}</td>
        </tr>
      `).join("");
    }

    // Init
    loadAkun();
    loadMenu();
    loadTransaksi();
  </script>
</body>
</html>
