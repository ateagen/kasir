<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel - POS Resto</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 text-center text-xl font-bold shadow-md">
    Admin Panel - POS Kasir Resto Bunda Ana
  </header>

  <!-- Main Content -->
  <main class="flex-1 p-4 space-y-8">

    <!-- Form Tambah Akun -->
    <section class="bg-white p-4 rounded-xl shadow-md">
      <h2 class="text-lg font-semibold text-blue-700 mb-3">Tambah Akun</h2>
      <form id="form-akun" class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <input type="text" id="username" placeholder="Username" class="border p-2 rounded" required>
        <input type="password" id="password" placeholder="Password" class="border p-2 rounded" required>
        <select id="role" class="border p-2 rounded">
          <option value="kasir">Kasir</option>
          <option value="admin">Admin</option>
        </select>
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Tambah</button>
      </form>
      <table class="w-full mt-4 border">
        <thead class="bg-blue-100">
          <tr>
            <th class="border p-2">ID</th>
            <th class="border p-2">Username</th>
            <th class="border p-2">Role</th>
          </tr>
        </thead>
        <tbody id="akun-table"></tbody>
      </table>
    </section>

    <!-- Form Tambah Menu -->
    <section class="bg-white p-4 rounded-xl shadow-md">
      <h2 class="text-lg font-semibold text-blue-700 mb-3">Tambah Menu</h2>
      <form id="form-menu" class="grid grid-cols-1 md:grid-cols-4 gap-3">
        <input type="text" id="nama-menu" placeholder="Nama Menu" class="border p-2 rounded" required>
        <input type="number" id="harga" placeholder="Harga" class="border p-2 rounded" required>
        <input type="text" id="kategori" placeholder="Kategori" class="border p-2 rounded">
        <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Tambah</button>
      </form>
      <table class="w-full mt-4 border">
        <thead class="bg-blue-100">
          <tr>
            <th class="border p-2">ID</th>
            <th class="border p-2">Nama</th>
            <th class="border p-2">Harga</th>
            <th class="border p-2">Kategori</th>
          </tr>
        </thead>
        <tbody id="menu-table"></tbody>
      </table>
    </section>

    <!-- Kontrol Kas -->
    <section class="bg-white p-4 rounded-xl shadow-md space-y-4">
      <h2 class="text-lg font-semibold text-blue-700 mb-3">Kontrol Kas</h2>
      <button id="reset-kas" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Reset Kas Awal ke 0</button>
      <button id="hapus-transaksi" class="bg-red-600 text-white px-4 py-2 rounded hover:bg-red-700">Hapus Semua Transaksi</button>
    </section>

    <!-- Tombol Kembali -->
    <div class="text-center">
      <button id="logout" class="bg-gray-500 text-white px-6 py-2 rounded hover:bg-gray-600">Kembali ke Layar Awal</button>
    </div>

  </main>

  <!-- Loading Popup -->
  <div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-lg shadow-lg text-center">
      <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent mx-auto"></div>
      <p class="mt-3 text-blue-700 font-medium">Memproses...</p>
    </div>
  </div>

  <!-- Custom Modal -->
  <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-lg w-80 text-center">
      <h3 id="modal-title" class="text-lg font-semibold text-blue-700 mb-3"></h3>
      <p id="modal-message" class="mb-4 text-gray-700"></p>
      <div id="modal-buttons" class="space-x-3"></div>
    </div>
  </div>

  <!-- Login Popup -->
  <div id="login-popup" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50">
    <div class="bg-white p-6 rounded-xl shadow-lg w-80">
      <h2 class="text-xl font-semibold text-blue-700 mb-4">Login Admin</h2>
      <form id="login-form" class="space-y-3">
        <input type="text" id="login-username" placeholder="Username" class="border p-2 w-full rounded" required>
        <input type="password" id="login-password" placeholder="Password" class="border p-2 w-full rounded" required>
        <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">Login</button>
      </form>
    </div>
  </div>

  <script>
    // Supabase Client
    const { createClient } = supabase;
    const supabaseUrl = "https://linujagdxugmocstckmd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxpbnVqYWdkeHVnbW9jc3Rja21kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NDA2NDQsImV4cCI6MjA3MjExNjY0NH0.VWGFS7xy5_f2Iplxqn07HTnfWUIILbRYv4m_RV7YEHI";
    const db = createClient(supabaseUrl, supabaseKey);

    const loginPopup = document.getElementById("login-popup");
    const loading = document.getElementById("loading");

    // === MODAL HANDLER ===
    const modal = document.getElementById("modal");
    const modalTitle = document.getElementById("modal-title");
    const modalMessage = document.getElementById("modal-message");
    const modalButtons = document.getElementById("modal-buttons");

    function showModal(title, message, buttons = []) {
      modalTitle.textContent = title;
      modalMessage.textContent = message;
      modalButtons.innerHTML = "";
      buttons.forEach(btn => {
        const button = document.createElement("button");
        button.textContent = btn.text;
        button.className = btn.class;
        button.onclick = () => {
          modal.classList.add("hidden");
          btn.onClick();
        };
        modalButtons.appendChild(button);
      });
      modal.classList.remove("hidden");
    }

    // === LOGIN HANDLER ===
    document.getElementById("login-form").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("login-username").value;
      const password = document.getElementById("login-password").value;

      showLoading(true);
      const { data } = await db.from("akun").select("*").eq("username", username).eq("password", password).eq("role", "admin").single();
      showLoading(false);

      if (data) {
        sessionStorage.setItem("adminLogin", "true");
        loginPopup.classList.add("hidden");
        loadAkun();
        loadMenu();
      } else {
        showModal("Login Gagal", "Username/Password salah atau bukan admin.", [
          { text: "OK", class: "bg-blue-600 text-white px-4 py-2 rounded", onClick: () => {} }
        ]);
      }
    });

    // Auto-login session
    window.addEventListener("load", () => {
      if (sessionStorage.getItem("adminLogin") === "true") {
        loginPopup.classList.add("hidden");
        loadAkun();
        loadMenu();
      }
    });

    // Logout
    document.getElementById("logout").addEventListener("click", () => {
      sessionStorage.removeItem("adminLogin");
      window.location.href = "index.html";
    });

    // === AKUN ===
    async function loadAkun() {
      showLoading(true);
      const { data } = await db.from("akun").select("id, username, role").order("id");
      showLoading(false);
      const tbody = document.getElementById("akun-table");
      tbody.innerHTML = "";
      data.forEach(a => {
        tbody.innerHTML += `<tr>
          <td class="border p-2">${a.id}</td>
          <td class="border p-2">${a.username}</td>
          <td class="border p-2">${a.role}</td>
        </tr>`;
      });
    }

    document.getElementById("form-akun").addEventListener("submit", async (e) => {
      e.preventDefault();
      const username = document.getElementById("username").value;
      const password = document.getElementById("password").value;
      const role = document.getElementById("role").value;
      showLoading(true);
      await db.from("akun").insert([{ username, password, role }]);
      showLoading(false);
      loadAkun();
      e.target.reset();
      showModal("Berhasil", "Akun baru berhasil ditambahkan.", [
        { text: "OK", class: "bg-blue-600 text-white px-4 py-2 rounded", onClick: () => {} }
      ]);
    });

    // === MENU ===
    async function loadMenu() {
      showLoading(true);
      const { data } = await db.from("menu").select("*").order("id");
      showLoading(false);
      const tbody = document.getElementById("menu-table");
      tbody.innerHTML = "";
      data.forEach(m => {
        tbody.innerHTML += `<tr>
          <td class="border p-2">${m.id}</td>
          <td class="border p-2">${m.nama}</td>
          <td class="border p-2">${m.harga}</td>
          <td class="border p-2">${m.kategori || "-"}</td>
        </tr>`;
      });
    }

    document.getElementById("form-menu").addEventListener("submit", async (e) => {
      e.preventDefault();
      const nama = document.getElementById("nama-menu").value;
      const harga = document.getElementById("harga").value;
      const kategori = document.getElementById("kategori").value;
      showLoading(true);
      await db.from("menu").insert([{ nama, harga, kategori }]);
      showLoading(false);
      loadMenu();
      e.target.reset();
      showModal("Berhasil", "Menu baru berhasil ditambahkan.", [
        { text: "OK", class: "bg-blue-600 text-white px-4 py-2 rounded", onClick: () => {} }
      ]);
    });

    // === RESET KAS ===
    document.getElementById("reset-kas").addEventListener("click", () => {
      showModal("Konfirmasi", "Yakin reset kas awal hari ini ke 0?", [
        { text: "Batal", class: "bg-gray-400 text-white px-4 py-2 rounded", onClick: () => {} },
        { text: "Ya", class: "bg-yellow-500 text-white px-4 py-2 rounded", onClick: async () => {
            showLoading(true);
            await db.from("kas").update({ kas_awal: 0 }).eq("tanggal", new Date().toISOString().slice(0,10));
            showLoading(false);
            showModal("Berhasil", "Kas awal berhasil direset.", [
              { text: "OK", class: "bg-blue-600 text-white px-4 py-2 rounded", onClick: () => {} }
            ]);
          }
        }
      ]);
    });

    // === HAPUS SEMUA TRANSAKSI ===
    document.getElementById("hapus-transaksi").addEventListener("click", () => {
      showModal("Konfirmasi", "Yakin hapus semua transaksi? Data tidak bisa dikembalikan!", [
        { text: "Batal", class: "bg-gray-400 text-white px-4 py-2 rounded", onClick: () => {} },
        { text: "Ya", class: "bg-red-600 text-white px-4 py-2 rounded", onClick: async () => {
            showLoading(true);
            await db.from("transaksi_detail").delete().neq("id", 0);
            await db.from("transaksi").delete().neq("id", 0);
            showLoading(false);
            showModal("Berhasil", "Semua transaksi berhasil dihapus.", [
              { text: "OK", class: "bg-blue-600 text-white px-4 py-2 rounded", onClick: () => {} }
            ]);
          }
        }
      ]);
    });

    // === LOADING HANDLER ===
    function showLoading(show) {
      loading.classList.toggle("hidden", !show);
    }
  </script>
</body>
</html>
