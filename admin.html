<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin - POS Bunda Ana</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #e6f0ff;
      margin: 0;
      padding: 0;
    }
    header {
      background-color: #3399ff;
      color: white;
      padding: 15px;
      text-align: center;
    }
    main {
      padding: 20px;
    }
    h2 { color: #0059b3; }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    table, th, td { border: 1px solid #3399ff; }
    th, td { padding: 10px; text-align: left; }
    button {
      background-color: #3399ff;
      color: white;
      border: none;
      padding: 8px 12px;
      margin: 4px 0;
      cursor: pointer;
      border-radius: 4px;
    }
    button:hover { background-color: #2673cc; }
    input, select {
      padding: 6px;
      margin: 4px 0;
      border: 1px solid #3399ff;
      border-radius: 4px;
    }
    .form-group { margin-bottom: 10px; }
    .popup {
      position: fixed; top:0; left:0; width:100%; height:100%;
      background: rgba(0,0,0,0.5); display: flex;
      justify-content: center; align-items: center; display:none;
    }
    .popup-content {
      background: white; padding: 20px; border-radius: 8px;
      min-width: 300px; max-width: 400px; text-align: center;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/supabase.min.js"></script>
  <script>
    // ==============================
    // Supabase Config
    // ==============================
    const SUPABASE_URL = 'https://YOUR_SUPABASE_URL';
    const SUPABASE_KEY = 'YOUR_SUPABASE_ANON_KEY';
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let currentAdmin = null;

    // ==============================
    // Utility Popups
    // ==============================
    function showPopup(msg) {
      const popup = document.getElementById('popup');
      popup.querySelector('p').innerText = msg;
      popup.style.display = 'flex';
    }
    function hidePopup() { document.getElementById('popup').style.display = 'none'; }

    function confirmAction(msg) {
      return confirm(msg);
    }

    // ==============================
    // Login Admin
    // ==============================
    async function loginAdmin() {
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      const { data, error } = await supabase.rpc('login_akun', { p_username: username, p_password: password });

      if (error || data.length === 0) {
        alert('Username atau password salah');
        return;
      }

      if (data[0].role !== 'admin') {
        alert('Hanya admin yang bisa akses halaman ini');
        return;
      }

      currentAdmin = data[0];
      document.getElementById('loginDiv').style.display = 'none';
      document.getElementById('adminContent').style.display = 'block';
      loadAkun();
      loadMenu();
    }

    // ==============================
    // Load Akun
    // ==============================
    async function loadAkun() {
      const { data: akunData, error } = await supabase.from('akun').select('*');
      const tbody = document.getElementById('akunTableBody');
      tbody.innerHTML = '';
      akunData.forEach(a => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${a.username}</td>
          <td>${a.surname}</td>
          <td>${a.role}</td>
          <td><button onclick="hapusAkun('${a.id}')">Hapus</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function tambahAkun() {
      const username = document.getElementById('akunUsername').value;
      const surname = document.getElementById('akunSurname').value;
      const password = document.getElementById('akunPassword').value;
      const role = document.getElementById('akunRole').value;

      if(!confirmAction(`Tambah akun ${username}?`)) return;

      const { error } = await supabase.from('akun').insert([
        { username, surname, password: password, role }
      ]);

      if(error) { showPopup(error.message); return; }
      showPopup('Akun berhasil ditambah');
      loadAkun();
    }

    async function hapusAkun(id) {
      if(!confirmAction('Hapus akun ini?')) return;
      const { error } = await supabase.from('akun').delete().eq('id', id);
      if(error) { showPopup(error.message); return; }
      showPopup('Akun berhasil dihapus');
      loadAkun();
    }

    // ==============================
    // Load Menu
    // ==============================
    async function loadMenu() {
      const { data: menuData, error } = await supabase.from('menu').select('*');
      const tbody = document.getElementById('menuTableBody');
      tbody.innerHTML = '';
      menuData.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${m.nama}</td>
          <td>${m.harga}</td>
          <td>${m.kategori}</td>
          <td><button onclick="hapusMenu('${m.id}')">Hapus</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function tambahMenu() {
      const nama = document.getElementById('menuNama').value;
      const harga = parseFloat(document.getElementById('menuHarga').value);
      const kategori = document.getElementById('menuKategori').value;

      if(!confirmAction(`Tambah menu ${nama}?`)) return;

      const { error } = await supabase.from('menu').insert([{ nama, harga, kategori }]);
      if(error) { showPopup(error.message); return; }
      showPopup('Menu berhasil ditambah');
      loadMenu();
    }

    async function hapusMenu(id) {
      if(!confirmAction('Hapus menu ini?')) return;
      const { error } = await supabase.from('menu').delete().eq('id', id);
      if(error) { showPopup(error.message); return; }
      showPopup('Menu berhasil dihapus');
      loadMenu();
    }

    // ==============================
    // Reset Kas Awal
    // ==============================
    async function resetKas() {
      if(!confirmAction('Reset kas awal semua kasir ke 0?')) return;
      const { data: kasirData } = await supabase.from('akun').select('id').eq('role','kasir');
      for(const k of kasirData){
        await supabase.rpc('reset_kas_awal', { kasir_uuid: k.id, saldo_baru: 0 });
      }
      showPopup('Kas awal berhasil direset');
    }

    // ==============================
    // Hapus Semua Transaksi
    // ==============================
    async function hapusSemuaTransaksi() {
      if(!confirmAction('Hapus semua transaksi?')) return;
      const { error } = await supabase.rpc('hapus_semua_transaksi');
      if(error) { showPopup(error.message); return; }
      showPopup('Semua transaksi berhasil dihapus');
    }

  </script>
</head>
<body>

  <!-- Login Admin -->
  <div id="loginDiv" style="padding:20px;">
    <h2>Login Admin</h2>
    <div class="form-group">
      <input type="text" id="loginUsername" placeholder="Username">
    </div>
    <div class="form-group">
      <input type="password" id="loginPassword" placeholder="Password">
    </div>
    <button onclick="loginAdmin()">Login</button>
  </div>

  <!-- Konten Admin -->
  <main id="adminContent" style="display:none;">
    <button onclick="window.location.href='index.html'">Kembali ke Index</button>

    <h2>Tambah Akun</h2>
    <div class="form-group">
      <input type="text" id="akunUsername" placeholder="Username">
      <input type="text" id="akunSurname" placeholder="Nama">
      <input type="password" id="akunPassword" placeholder="Password">
      <select id="akunRole">
        <option value="admin">Admin</option>
        <option value="kasir">Kasir</option>
      </select>
      <button onclick="tambahAkun()">Tambah Akun</button>
    </div>

    <h2>Tabel Akun</h2>
    <table>
      <thead>
        <tr>
          <th>Username</th>
          <th>Nama</th>
          <th>Role</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="akunTableBody"></tbody>
    </table>

    <h2>Tambah Menu</h2>
    <div class="form-group">
      <input type="text" id="menuNama" placeholder="Nama Menu">
      <input type="number" id="menuHarga" placeholder="Harga">
      <select id="menuKategori">
        <option value="makanan">Makanan</option>
        <option value="minuman">Minuman</option>
      </select>
      <button onclick="tambahMenu()">Tambah Menu</button>
    </div>

    <h2>Tabel Menu</h2>
    <table>
      <thead>
        <tr>
          <th>Nama</th>
          <th>Harga</th>
          <th>Kategori</th>
          <th>Aksi</th>
        </tr>
      </thead>
      <tbody id="menuTableBody"></tbody>
    </table>

    <button onclick="resetKas()">Reset Kas Awal Semua Kasir</button>
    <button onclick="hapusSemuaTransaksi()">Hapus Semua Transaksi</button>
  </main>

  <!-- Popup -->
  <div id="popup" class="popup" onclick="hidePopup()">
    <div class="popup-content">
      <p></p>
      <button onclick="hidePopup()">Tutup</button>
    </div>
  </div>

</body>
</html>
