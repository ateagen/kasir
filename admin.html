<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Admin Panel</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js"></script>
</head>
<body class="bg-blue-50 min-h-screen flex flex-col">
  <!-- Header -->
  <header class="bg-blue-600 text-white p-4 text-center text-xl font-bold shadow-md">
    Panel Admin
  </header>

  <!-- Kontainer utama -->
  <main class="flex-1 p-6 space-y-6">
    <!-- Form Tambah Akun -->
    <section class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold text-blue-700 mb-4">Tambah Akun</h2>
      <div class="flex flex-col md:flex-row gap-4">
        <input id="newUsername" type="text" placeholder="Username" class="border p-2 rounded w-full">
        <input id="newPassword" type="password" placeholder="Password" class="border p-2 rounded w-full">
        <select id="newRole" class="border p-2 rounded w-full">
          <option value="kasir">Kasir</option>
          <option value="admin">Admin</option>
        </select>
        <button id="addAccountBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Submit</button>
      </div>
    </section>

    <!-- Tabel Akun -->
    <section class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold text-blue-700 mb-4">Daftar Akun</h2>
      <div class="overflow-x-auto">
        <table class="w-full border border-gray-200">
          <thead class="bg-blue-100">
            <tr>
              <th class="p-2 border">ID</th>
              <th class="p-2 border">Username</th>
              <th class="p-2 border">Role</th>
              <th class="p-2 border">Aksi</th>
            </tr>
          </thead>
          <tbody id="akunTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Form Tambah Menu -->
    <section class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold text-blue-700 mb-4">Tambah Menu</h2>
      <div class="flex flex-col md:flex-row gap-4">
        <input id="newMenuName" type="text" placeholder="Nama Menu" class="border p-2 rounded w-full">
        <input id="newMenuPrice" type="number" placeholder="Harga" class="border p-2 rounded w-full">
        <button id="addMenuBtn" class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600">Submit</button>
      </div>
    </section>

    <!-- Tabel Menu -->
    <section class="bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold text-blue-700 mb-4">Daftar Menu</h2>
      <div class="overflow-x-auto">
        <table class="w-full border border-gray-200">
          <thead class="bg-blue-100">
            <tr>
              <th class="p-2 border">ID</th>
              <th class="p-2 border">Nama</th>
              <th class="p-2 border">Harga</th>
              <th class="p-2 border">Aksi</th>
            </tr>
          </thead>
          <tbody id="menuTable"></tbody>
        </table>
      </div>
    </section>

    <!-- Card Manajemen Kas (khusus admin) -->
    <section id="kasManagement" class="hidden bg-white p-6 rounded-2xl shadow-md">
      <h2 class="text-lg font-semibold text-blue-700 mb-4">Manajemen Kas</h2>
      <div class="flex flex-col md:flex-row gap-4">
        <button id="resetKasBtn" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Reset Kas Awal</button>
        <button id="hapusTransaksiBtn" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Hapus Semua Transaksi</button>
      </div>
    </section>
  </main>

  <!-- Login Popup -->
  <div id="loginPopup" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50">
    <div class="bg-white p-6 rounded-2xl shadow-md w-80">
      <h2 class="text-xl font-bold text-blue-700 mb-4">Login Admin</h2>
      <input id="loginUsername" type="text" placeholder="Username" class="border p-2 rounded w-full mb-3">
      <input id="loginPassword" type="password" placeholder="Password" class="border p-2 rounded w-full mb-3">
      <button id="loginBtn" class="bg-blue-500 text-white px-4 py-2 rounded w-full hover:bg-blue-600">Login</button>
    </div>
  </div>

  <script>
    const supabaseUrl = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const supabase = supabase.createClient(supabaseUrl, supabaseKey);

    let currentUser = null;

    // Cek session dari localStorage
    window.onload = () => {
      const savedUser = localStorage.getItem("adminSession");
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        document.getElementById("loginPopup").classList.add("hidden");
        if (currentUser.role === "admin") {
          document.getElementById("kasManagement").classList.remove("hidden");
        }
        loadAkun();
        loadMenu();
      }
    };

    // Login
    document.getElementById("loginBtn").onclick = async () => {
      const username = document.getElementById("loginUsername").value;
      const password = document.getElementById("loginPassword").value;

      const { data, error } = await supabase
        .from("akun")
        .select("*")
        .eq("username", username)
        .eq("password", password)
        .eq("role", "admin")
        .single();

      if (data) {
        currentUser = data;
        localStorage.setItem("adminSession", JSON.stringify(currentUser));
        document.getElementById("loginPopup").classList.add("hidden");
        if (currentUser.role === "admin") {
          document.getElementById("kasManagement").classList.remove("hidden");
        }
        loadAkun();
        loadMenu();
      } else {
        alert("Login gagal. Pastikan kredensial admin benar.");
      }
    };

    // Tambah Akun
    document.getElementById("addAccountBtn").onclick = async () => {
      const username = document.getElementById("newUsername").value;
      const password = document.getElementById("newPassword").value;
      const role = document.getElementById("newRole").value;
      const { error } = await supabase.from("akun").insert([{ username, password, role }]);
      if (!error) {
        alert("Akun berhasil ditambahkan");
        loadAkun();
      }
    };

    // Load Akun
    async function loadAkun() {
      const { data } = await supabase.from("akun").select("*").order("id");
      const tbody = document.getElementById("akunTable");
      tbody.innerHTML = "";
      data.forEach(acc => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2 border">${acc.id}</td>
          <td class="p-2 border">${acc.username}</td>
          <td class="p-2 border">${acc.role}</td>
          <td class="p-2 border">
            <button onclick="deleteAkun(${acc.id})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Hapus akun
    async function deleteAkun(id) {
      if (confirm("Yakin hapus akun ini?")) {
        await supabase.from("akun").delete().eq("id", id);
        loadAkun();
      }
    }

    // Tambah Menu
    document.getElementById("addMenuBtn").onclick = async () => {
      const nama = document.getElementById("newMenuName").value;
      const harga = document.getElementById("newMenuPrice").value;
      const { error } = await supabase.from("menu").insert([{ nama, harga }]);
      if (!error) {
        alert("Menu berhasil ditambahkan");
        loadMenu();
      }
    };

    // Load Menu
    async function loadMenu() {
      const { data } = await supabase.from("menu").select("*").order("id");
      const tbody = document.getElementById("menuTable");
      tbody.innerHTML = "";
      data.forEach(menu => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="p-2 border">${menu.id}</td>
          <td class="p-2 border">${menu.nama}</td>
          <td class="p-2 border">${menu.harga}</td>
          <td class="p-2 border">
            <button onclick="deleteMenu(${menu.id})" class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600">Hapus</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    // Hapus menu
    async function deleteMenu(id) {
      if (confirm("Yakin hapus menu ini?")) {
        await supabase.from("menu").delete().eq("id", id);
        loadMenu();
      }
    }

    // Reset Kas Awal
    document.getElementById("resetKasBtn").onclick = async () => {
      if (confirm("Yakin reset kas awal hari ini jadi 0?")) {
        const { error } = await supabase.from("kas_override").insert([{ tanggal: new Date().toISOString().slice(0,10), kas_awal_override: 0 }]);
        if (!error) {
          alert("Kas awal berhasil direset ke 0");
        }
      }
    };

    // Hapus Semua Transaksi
    document.getElementById("hapusTransaksiBtn").onclick = async () => {
      if (confirm("Yakin hapus semua transaksi & pengeluaran? Data tidak bisa dikembalikan.")) {
        const { error } = await supabase.rpc("reset_kas");
        if (!error) {
          alert("Semua transaksi & pengeluaran berhasil dihapus");
        }
      }
    };
  </script>
</body>
</html>
