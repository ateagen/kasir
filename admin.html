<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <!-- ðŸ”’ Popup Login -->
  <div id="loginModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
    <div class="bg-white rounded-lg shadow-lg p-6 w-96">
      <h2 class="text-xl font-bold mb-4 text-center">Login Admin</h2>
      <input id="loginUsername" type="text" placeholder="Username"
        class="w-full p-2 border rounded mb-2" />
      <input id="loginPassword" type="password" placeholder="Password"
        class="w-full p-2 border rounded mb-4" />
      <button onclick="handleLogin()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">
        Login
      </button>
    </div>
  </div>

  <!-- ðŸ”‘ Header -->
  <header class="bg-white shadow p-4 flex justify-between items-center">
    <h1 class="text-2xl font-bold">Admin Dashboard</h1>
    <button onclick="logout()" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">
      Logout
    </button>
  </header>

  <main class="p-6 space-y-8">
    <!-- ðŸ‘¥ CRUD User -->
    <section>
      <h2 class="text-xl font-semibold mb-2">Kelola User</h2>
      <div class="flex space-x-2 mb-4">
        <input id="newUserUsername" placeholder="Username" class="p-2 border rounded" />
        <input id="newUserPassword" type="password" placeholder="Password" class="p-2 border rounded" />
        <select id="newUserRole" class="p-2 border rounded">
          <option value="admin">Admin</option>
          <option value="kasir">Kasir</option>
        </select>
        <button onclick="addUser()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Tambah</button>
      </div>
      <table class="w-full bg-white rounded shadow">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2">ID</th>
            <th class="p-2">Username</th>
            <th class="p-2">Role</th>
            <th class="p-2">Aksi</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
    </section>

    <!-- ðŸ“¦ CRUD Barang -->
    <section>
      <h2 class="text-xl font-semibold mb-2">Kelola Barang</h2>
      <div class="flex space-x-2 mb-4">
        <input id="newBarangNama" placeholder="Nama Barang" class="p-2 border rounded" />
        <input id="newBarangHarga" type="number" placeholder="Harga" class="p-2 border rounded" />
        <input id="newBarangStok" type="number" placeholder="Stok" class="p-2 border rounded" />
        <button onclick="addBarang()" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600">Tambah</button>
      </div>
      <table class="w-full bg-white rounded shadow">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2">ID</th>
            <th class="p-2">Nama</th>
            <th class="p-2">Harga</th>
            <th class="p-2">Stok</th>
            <th class="p-2">Aksi</th>
          </tr>
        </thead>
        <tbody id="barangTable"></tbody>
      </table>
    </section>

    <!-- ðŸ’° Transaksi -->
    <section>
      <h2 class="text-xl font-semibold mb-2">Semua Transaksi</h2>
      <input id="filterTanggal" type="date" onchange="loadTransaksi()" class="p-2 border rounded mb-4" />
      <table class="w-full bg-white rounded shadow">
        <thead>
          <tr class="bg-gray-200">
            <th class="p-2">ID</th>
            <th class="p-2">Tanggal</th>
            <th class="p-2">Jenis</th>
            <th class="p-2">Jumlah</th>
            <th class="p-2">Keterangan</th>
          </tr>
        </thead>
        <tbody id="transaksiTable"></tbody>
      </table>
    </section>
  </main>

  <script>
    // ðŸ”‘ Konfigurasi Supabase
    const SUPABASE_URL = "https://flrxlfxomfvcdjukedzd.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZscnhsZnhvbWZ2Y2RqdWtlZHpkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY3MTkxNzUsImV4cCI6MjA3MjI5NTE3NX0.-zrx2JWMw03gDjLnrEa_WxQyiUOPdZ_WFYiE7VA1KhY";
    const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ðŸ”’ Login
    async function handleLogin() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();

      const { data, error } = await supabase
        .from("users")
        .select("*")
        .eq("username", username)
        .eq("password", password)
        .single();

      if (error || !data) {
        alert("Akun tidak dikenali, Anda akan kembali ke halaman awal.");
        window.location.href = "index.html";
        return;
      }

      if (data.role !== "admin") {
        alert("Hanya admin yang bisa mengakses halaman ini!");
        window.location.href = "index.html";
        return;
      }

      localStorage.setItem("user", JSON.stringify(data));
      document.getElementById("loginModal").style.display = "none";
    }

    function logout() {
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    // ðŸ”§ Load Data
    async function loadUsers() {
      const { data } = await supabase.from("users").select("*");
      const tbody = document.getElementById("userTable");
      tbody.innerHTML = data.map(u => `
        <tr class="border-b">
          <td class="p-2">${u.id}</td>
          <td class="p-2">${u.username}</td>
          <td class="p-2">${u.role}</td>
          <td class="p-2">
            <button onclick="deleteUser(${u.id})" class="bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
          </td>
        </tr>
      `).join("");
    }

    async function addUser() {
      const username = document.getElementById("newUserUsername").value.trim();
      const password = document.getElementById("newUserPassword").value.trim();
      const role = document.getElementById("newUserRole").value;

      await supabase.from("users").insert([{ username, password, role }]);
      loadUsers();
    }

    async function deleteUser(id) {
      await supabase.from("users").delete().eq("id", id);
      loadUsers();
    }

    async function loadBarang() {
      const { data } = await supabase.from("barang").select("*");
      const tbody = document.getElementById("barangTable");
      tbody.innerHTML = data.map(b => `
        <tr class="border-b">
          <td class="p-2">${b.id}</td>
          <td class="p-2">${b.nama}</td>
          <td class="p-2">${b.harga}</td>
          <td class="p-2">${b.stok}</td>
          <td class="p-2">
            <button onclick="deleteBarang(${b.id})" class="bg-red-500 text-white px-2 py-1 rounded">Hapus</button>
          </td>
        </tr>
      `).join("");
    }

    async function addBarang() {
      const nama = document.getElementById("newBarangNama").value.trim();
      const harga = parseFloat(document.getElementById("newBarangHarga").value);
      const stok = parseInt(document.getElementById("newBarangStok").value);

      await supabase.from("barang").insert([{ nama, harga, stok }]);
      loadBarang();
    }

    async function deleteBarang(id) {
      await supabase.from("barang").delete().eq("id", id);
      loadBarang();
    }

    async function loadTransaksi() {
      const tanggal = document.getElementById("filterTanggal").value;
      let query = supabase.from("transaksi").select("*").order("tanggal", { ascending: false });

      if (tanggal) query = query.eq("tanggal", tanggal);

      const { data } = await query;
      const tbody = document.getElementById("transaksiTable");
      tbody.innerHTML = data.map(t => `
        <tr class="border-b">
          <td class="p-2">${t.id}</td>
          <td class="p-2">${t.tanggal}</td>
          <td class="p-2">${t.jenis}</td>
          <td class="p-2">${t.jumlah}</td>
          <td class="p-2">${t.keterangan || ""}</td>
        </tr>
      `).join("");
    }

    // ðŸ”§ Inisialisasi
    window.onload = async () => {
      const user = JSON.parse(localStorage.getItem("user"));
      if (!user) {
        document.getElementById("loginModal").style.display = "flex";
      } else if (user.role !== "admin") {
        alert("Hanya admin yang bisa mengakses halaman ini!");
        window.location.href = "index.html";
      } else {
        document.getElementById("loginModal").style.display = "none";
      }

      loadUsers();
      loadBarang();
      loadTransaksi();
    };
  </script>
</body>
</html>
